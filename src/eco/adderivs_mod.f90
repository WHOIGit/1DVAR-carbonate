
module adderivs_mod

contains

subroutine adderivs(y, bioparams, yb, dydttb, dydtt_diagb, & 
                    istep, iz, bioparamsb)
!***************************************************************
!***************************************************************
!** This routine was generated by the                         **
!** Tangent linear and Adjoint Model Compiler,  TAMC 5.3.2    **
!***************************************************************
!***************************************************************
    use const, only : c0,c1,SecPerDay
    !use grid, only: delt
    use eco_common, only : rlt
    use eco_params, only : iae, imu_SP,ialpha_SP,ia_SP,iv_SPn,ik_nh4SP,ik_no3SP,&
          iv_SPp,ik_po4SP,izeta,itheta, ir_excrSP_1,ir_excrSP_2,ir_pomSP,imu_TR,ialpha_TR,ia_TR,&
          iv_TRn,ik_nh4TR,ik_no3TR,iv_TRp,ik_po4TR,imu_pickTRpo4, izeta_nf,&
          ir_excrTR_1,ir_excrTR_n,ir_excrTR_2,ir_pomTR,imu_UN,&
          ialpha_UN,ik_DOM,ir_SDOM,imu_BA,& !ib_SDONlabi,ib_SDOPlabi,
          ib_BAresp,ir_BAadju,ir_BAremi,ir_BArefr,&
          if_BAslct,ir_BAresp_1, ir_BAresp_min, ir_BAresp_max,ir_BAmort, & 
          imu_PRT,ig_sp,ig_ba,&
          ir_PRTex,if_exPRTldom,ir_PRTresp_1,&
          ir_PRTresp_2,ir_PRTadju,ir_PRTremi,&
          ir_pomPRT,imu_MZ,ig_prt,ig_tr,&
          ir_MZex,if_exMZldom,ir_MZresp_1,ir_MZresp_2,&
          ir_MZadju,ir_MZremi,ir_MZpom,ir_MZrefr,ir_MZremv,if_HZsdom,if_HZpom,ir_SDOMrefr,&
          iq_refrDOM_n, iq_refrDOM_p,iq_POM_n,iq_POM_p,&
          ir_nitrf,iremin_prf_n,iremin_prf_p,iwnsvo,iremin
    use eco_params, only : NumStateVar,NumDiagVar
    use eco_params, only : iSPc,iSPn,iSPp,iTRc,iTRn,iTRp,iUNc,iUNn,iUNp, &
                            iBAc,iBAn,iBAp,iPRTc,iPRTn,iPRTp,iMZc,iMZn,iMZp, &
                            iLDOMc,iLDOMn,iLDOMp,iSDOMc,iSDOMn,iSDOMp, &
                            iDETc,iDETn,iDETp,iNH4,iNO3,iPO4,iSPchl,iTRchl,iUNchl
    use eco_params, only : iPP,iprBAc
    use forcing, only : Tdat
    use adeco_common, only : rltb

!==============================================
! all entries are defined explicitly
!==============================================
implicit none

!==============================================
! define arguments
!==============================================
    double precision, dimension(:) ::  bioparams,bioparamsb
    double precision, dimension(:) :: dydttb,yb,y,dydtt_diagb
    integer :: istep,iz
!==============================================
! define local variables
!==============================================
double precision dydtt(numstatevar)
double precision dydtt_diag(numdiagvar)
DOUBLE PRECISION :: a_sp, a_spb, a_tr, a_trb, a_un, a_unb, ae, aeb, &
&  alc, alcb, alpha_sp, alpha_spb, alpha_tr, alpha_trb, alpha_un, &
&  alpha_unb, asc, ascb, b_baresp, b_barespb, disdetc, disdetcb, disdetn&
&  , disdetnb, disdetp, disdetpb, excrbac, excrbacb, excrban, excrbanb, &
&  excrbap, excrbapb, excrhzsdomc, excrhzsdomcb, excrhzsdomn, &
&  excrhzsdomnb, excrhzsdomp, excrhzsdompb, excrmzldomc, excrmzldomcb, &
&  excrmzldomn, excrmzldomnb, excrmzldomp, excrmzldompb, excrmzsdom2c, &
&  excrmzsdom2cb, excrmzsdom2n, excrmzsdom2nb, excrmzsdom2p, &
&  excrmzsdom2pb, excrmzsdomc, excrmzsdomcb, excrmzsdomn, excrmzsdomnb, &
&  excrmzsdomp, excrmzsdompb, excrprtldomc, excrprtldomcb, excrprtldomn&
&  , excrprtldomnb, excrprtldomp, excrprtldompb, excrprtsdom2c, &
&  excrprtsdom2cb, excrprtsdom2n, excrprtsdom2nb, excrprtsdom2p, &
&  excrprtsdom2pb, excrprtsdomc, excrprtsdomcb, excrprtsdomn, &
&  excrprtsdomnb, excrprtsdomp, excrprtsdompb, excrsp_1c, excrsp_1cb, &
&  excrsp_1n, excrsp_1nb
  DOUBLE PRECISION :: excrsp_1p, excrsp_1pb, excrsp_2c, excrsp_2cb, &
&  excrsp_2n, excrsp_2nb, excrsp_2p, excrsp_2pb, excrtr_1c, excrtr_1cb, &
&  excrtr_1n, excrtr_1nb, excrtr_1p, excrtr_1pb, excrtr_2c, excrtr_2cb, &
&  excrtr_2n, excrtr_2nb, excrtr_2p, excrtr_2pb, excrtr_nh4, excrtr_nh4b&
&  , excrun_1c, excrun_1cb, excrun_1n, excrun_1nb, excrun_1p, excrun_1pb&
&  , excrun_2c, excrun_2cb, excrun_2n, excrun_2nb, excrun_2p, excrun_2pb&
&  , excrun_nh4, excrun_nh4b, f_baslct, f_baslctb, f_exmzldom, &
&  f_exmzldomb, f_exprtldom, f_exprtldomb, f_hzpom, f_hzpomb, f_hzsdom, &
&  f_hzsdomb, fluxbanh4, fluxbanh4b, fluxbano3, fluxbano3b, fluxbapo4, &
&  fluxbapo4b, g_ba, g_bab, g_prt, g_prtb, g_sp, g_spb, g_tr, g_trb, &
&  g_un, g_unb, grazbac, grazbacb, grazban, grazbanb, grazbap, grazbapb&
&  , grazprtc, grazprtcb, grazprtn, grazprtnb, grazprtp, grazprtpb, &
&  grazspc, grazspcb, grazspchl, grazspchlb
  DOUBLE PRECISION :: grazspn, grazspnb, grazspp, grazsppb, graztrc, &
&  graztrcb, graztrchl, graztrchlb, graztrn, graztrnb, graztrp, graztrpb&
&  , grazunc, grazuncb, grazunchl, grazunchlb, grazunn, grazunnb, &
&  grazunp, grazunpb, growbac, growbacb, growbaldoc, growbaldocb, &
&  growbaldon, growbaldonb, growbaldop, growbaldopb, growban, growbanb, &
&  growbanh4, growbanh4b, growbano3, growbano3b, growbap, growbapb, &
&  growbapo4, growbapo4b, growbasdoc, growbasdocb, growbasdon, &
&  growbasdonb, growbasdop, growbasdopb, growmzc, growmzcb, growmzn, &
&  growmznb, growmzp, growmzpb, growprtc, growprtcb, growprtn, growprtnb&
&  , growprtp, growprtpb, growspc, growspcb, growspchl, growspchlb, &
&  growspn, growspnb, growspnh4, growspnh4b, growspno3, growspno3b, &
&  growspp, growsppb, growtrc, growtrcb, growtrchl, growtrchlb, growtrn&
&  , growtrnb, growtrnf, growtrnfb, growtrnh4, growtrnh4b
  DOUBLE PRECISION :: growtrno3, growtrno3b, growtrp, growtrpb, &
&  growtrpo4, growtrpo4b, growunc, growuncb, growunchl, growunchlb, &
&  growunn, growunnb, growunnf, growunnfb, growunnh4, growunnh4b, &
&  growunno3, growunno3b, growunp, growunpb, k_dom, k_domb, k_nh4sp, &
&  k_nh4spb, k_nh4tr, k_nh4trb, k_nh4un, k_nh4unb, k_no3sp, k_no3spb, &
&  k_no3tr, k_no3trb, k_no3un, k_no3unb, k_po4sp, k_po4spb, k_po4tr, &
&  k_po4trb, k_po4un, k_po4unb, max1, max1b, max2, max2b, max3, max3b, &
&  max4, max4b, maxtrnf, maxtrnfb, maxunnf, maxunnfb, min1, min10, &
&  min10b, min11, min11b, min12, min12b, min13, min13b, min14, min14b, &
&  min15, min15b, min1b, min2, min2b, min3, min3b, min4, min4b, min5, &
&  min5b, min6, min6b, min7, min7b
  DOUBLE PRECISION :: min8, min8b, min9, min9b, mortbac, mortbacb, &
&  mortban, mortbanb, mortbap, mortbapb, mu_ba, mu_bab, mu_mz, mu_mzb, &
&  mu_picktrpo4, mu_picktrpo4b, mu_prt, mu_prtb, mu_sp, mu_spb, mu_tr, &
&  mu_trb, mu_un, mu_unb, nfunc_ba_n, nfunc_ba_nb, nfunc_ba_p, &
&  nfunc_ba_pb, nfunc_sp_n, nfunc_sp_nb, nfunc_sp_p, nfunc_sp_pb, &
&  nfunc_tr_n, nfunc_tr_nb, nfunc_tr_p, nfunc_tr_pb, nfunc_un_n, &
&  nfunc_un_nb, nfunc_un_p, nfunc_un_pb, nitrf, nitrfb, pc_spmax, &
&  pc_spmaxb, pc_trmax, pc_trmaxb, pc_unmax, pc_unmaxb, picktrpo4, &
&  picktrpo4b, pomhzc, pomhzcb, pomhzn, pomhznb, pomhzp, pomhzpb, pommzc&
&  , pommzcb, pommzn, pommznb, pommzp, pommzpb, pomprtc, pomprtcb, &
&  pomprtn, pomprtnb, pomprtp, pomprtpb, pomspc, pomspcb, pomspchl, &
&  pomspchlb, pomspn, pomspnb, pomspp, pomsppb, pomtrc, pomtrcb
  DOUBLE PRECISION :: pomtrchl, pomtrchlb, pomtrn, pomtrnb, pomtrp, &
&  pomtrpb, pomunc, pomuncb, pomunchl, pomunchlb, pomunn, pomunnb, &
&  pomunp, pomunpb, q_ba_n, q_ba_p, q_mz_n, q_mz_p, q_pom_n, q_pom_nb, &
&  q_pom_p, q_pom_pb, q_prt_n, q_prt_p, q_refrdom_n, q_refrdom_nb, &
&  q_refrdom_p, q_refrdom_pb, q_sp_max_n, q_sp_max_p, q_sp_min_n, &
&  q_sp_min_p, q_sp_rdf_n, q_sp_rdf_p, q_tr_max_n, q_tr_max_p, &
&  q_tr_min_n, q_tr_min_p, q_tr_rdf_n, q_tr_rdf_p, q_un_max0_n, &
&  q_un_max_n, q_un_max_p, q_un_min0_n, q_un_min0_p, q_un_min_n, &
&  q_un_min_p, q_un_rdf_n, q_un_rdf_p, r_baadju, r_baadjub, r_bamort, &
&  r_bamortb, r_barefr, r_barefrb, r_baremi, r_baremib, r_baresp_1, &
&  r_baresp_1b, r_baresp_max, r_baresp_maxb, r_baresp_min, r_baresp_minb&
&  , r_excrsp_1, r_excrsp_1b, r_excrsp_2, r_excrsp_2b, r_excrtr_1, &
&  r_excrtr_1b, r_excrtr_2, r_excrtr_2b, r_excrtr_n, r_excrtr_nb, &
&  r_excrun_1, r_excrun_1b, r_excrun_2, r_excrun_2b, r_excrun_n
  DOUBLE PRECISION :: r_excrun_nb, r_mzadju, r_mzadjub, r_mzex, r_mzexb&
&  , r_mzpom, r_mzpomb, r_mzrefr, r_mzrefrb, r_mzremi, r_mzremib, &
&  r_mzremv, r_mzremvb, r_mzresp_1, r_mzresp_1b, r_mzresp_2, r_mzresp_2b&
&  , r_nitrf, r_nitrfb, r_pomprt, r_pomprtb, r_pomsp, r_pomspb, r_pomtr&
&  , r_pomtrb, r_pomun, r_pomunb, r_prtadju, r_prtadjub, r_prtex, &
&  r_prtexb, r_prtremi, r_prtremib, r_prtresp_1, r_prtresp_1b, &
&  r_prtresp_2, r_prtresp_2b, r_sdom, r_sdomb, r_sdomrefr, r_sdomrefrb, &
&  refrbac, refrbacb, refrban, refrbanb, refrbap, refrbapb, refrmzc, &
&  refrmzcb, refrmzn, refrmznb, refrmzp, refrmzpb, refrsdomc, refrsdomcb&
&  , refrsdomn, refrsdomnb, refrsdomp, refrsdompb, remiban, remibanb, &
&  remibap, remibapb, remihzn, remihznb, remihzp, remihzpb, remimzn, &
&  remimznb, remimzp, remimzpb, remin, remin_prf_n, remin_prf_nb, &
&  remin_prf_p, remin_prf_pb, reminb, remiprtn
  DOUBLE PRECISION :: remiprtnb, remiprtp, remiprtpb, remvmzc, remvmzcb&
&  , remvmzn, remvmznb, remvmzp, remvmzpb, respba, respbab, respmz, &
&  respmzb, respprt, respprtb, respsp, respspb, resptr, resptrb, respun&
&  , respunb, temp, temp0, temp1, temp10, temp10b, temp11, temp11b, &
&  temp12, temp12b, temp12b0, temp12b1, temp13, temp13b, temp14, temp14b&
&  , temp14b0, temp14b1, temp15, temp15b, temp16, temp17, temp17b, &
&  temp17b0, temp17b1, temp17b2, temp17b3, temp17b4, temp17b5, temp17b6&
&  , temp18, temp18b, temp19, temp19b, temp1b, temp2, temp20, temp21, &
&  temp21b, temp22, temp23, temp23b, temp23b0, temp23b1, temp23b10, &
&  temp23b2, temp23b3, temp23b4, temp23b5, temp23b6, temp23b7, temp23b8&
&  , temp23b9, temp24, temp24b, temp25, temp26, temp27
  DOUBLE PRECISION :: temp27b, temp27b0, temp28, temp28b, temp29, &
&  temp29b, temp2b, temp2b0, temp2b1, temp2b2, temp2b3, temp3, temp30, &
&  temp30b, temp30b0, temp31, temp31b, temp32, temp32b, temp33, temp33b&
&  , temp33b0, temp34, temp34b, temp34b0, temp35, temp35b, temp35b0, &
&  temp36, temp36b, temp37, temp37b, temp37b0, temp37b1, temp38, temp38b&
&  , temp39, temp3b, temp4, temp40, temp40b, temp40b0, temp40b1, &
&  temp40b2, temp40b3, temp40b4, temp40b5, temp40b6, temp40b7, temp40b8&
&  , temp41, temp41b, temp42, temp43, temp43b, temp44, temp44b, temp44b0&
&  , temp44b1, temp44b10, temp44b2, temp44b3, temp44b4, temp44b5, &
&  temp44b6, temp44b7, temp44b8, temp44b9, temp45, temp45b, temp46, &
&  temp47, temp48, temp48b, temp48b0, temp49, temp49b, temp5
  DOUBLE PRECISION :: temp50, temp50b, temp51, temp51b, temp51b0, temp52&
&  , temp52b, temp53, temp53b, temp54, temp54b, temp54b0, temp55, &
&  temp55b, temp55b0, temp56, temp56b, temp56b0, temp57, temp57b, temp58&
&  , temp58b, temp58b0, temp58b1, temp59, temp59b, temp6, temp60, temp61&
&  , temp61b, temp61b0, temp61b1, temp61b2, temp61b3, temp61b4, temp61b5&
&  , temp61b6, temp61b7, temp61b8, temp62, temp62b, temp63, temp63b, &
&  temp64, temp65, temp65b, temp66, temp67, temp67b, temp67b0, temp67b1&
&  , temp67b2, temp67b3, temp67b4, temp67b5, temp67b6, temp67b7, &
&  temp67b8, temp68, temp68b, temp69, temp69b, temp6b, temp6b0, temp7, &
&  temp70, temp70b, temp71, temp71b, temp71b0, temp71b1, temp71b2, &
&  temp72, temp72b, temp72b0, temp72b1, temp73, temp73b
  DOUBLE PRECISION :: temp73b0, temp74, temp74b, temp75, temp75b, temp76&
&  , temp76b, temp76b0, temp77, temp77b, temp77b0, temp78, temp78b, &
&  temp79, temp79b, temp79b0, temp7b, temp8, temp80, temp80b, temp81, &
&  temp81b, temp82, temp83, temp83b, temp84, temp85, temp85b, temp85b0, &
&  temp85b1, temp85b2, temp85b3, temp85b4, temp86, temp87, temp87b, &
&  temp88, temp89, temp89b, temp89b0, temp89b1, temp89b2, temp89b3, &
&  temp8b, temp9, temp90, temp90b, temp91, temp92, temp92b, temp93, &
&  temp93b, temp93b0, temp93b1, temp93b2, temp93b3, temp93b4, temp94, &
&  temp95, temp95b, temp96, temp97b, temp97b0, temp97b1, temp97b10, &
&  temp97b11, temp97b12, temp97b13, temp97b14, temp97b15, temp97b16, &
&  temp97b17, temp97b18, temp97b19, temp97b2, temp97b20, temp97b21, &
&  temp97b22
  DOUBLE PRECISION :: temp97b23, temp97b24, temp97b25, temp97b3, &
&  temp97b4, temp97b5, temp97b6, temp97b7, temp97b8, temp97b9, temp9b, &
&  temp9b0, tempb, tfunc, tfuncb, theta, thetab, tref, v_spmax_n, &
&  v_spmax_nb, v_spmax_p, v_spmax_pb, v_spn, v_spnb, v_spp, v_sppb, &
&  v_trmax_n, v_trmax_nb, v_trmax_p, v_trmax_pb, v_trn, v_trnb, v_trp, &
&  v_trpb, v_unmax_n, v_unmax_nb, v_unmax_p, v_unmax_pb, v_unn, v_unnb, &
&  v_unp, v_unpb, wnsvo, x1, x1b, y1, y1b, y2, y2b, y3, y3b, y4, y4b, &
&  zeta, zeta_nf, zeta_nfb, zetab
  INTEGER :: branch
  INTRINSIC EXP, MAX, MIN
!-----------------------------------------------------------------------
!     Yawei Luo's microbial-loop and N2-fixation model
!
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!     Arguments
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!     Local variables
!-----------------------------------------------------------------------
!ib_SDONlabi     = ik_DOM        + 1, &
!ib_SDOPlabi     = ib_SDONlabi     + 1, &
! ecosystem model parameters
!b_SDONlabi,b_SDOPlabi,
! local fixed parameters
! local variables for temperature effect function
! local variables in the SP module
! local variables in the TR module
! local variables in the UN module
! local variables in the BA module
! local variables in the PRT module
! local variables in the MZ module
! local variables in the DOM module
! local variables in the DET module
! local variables in the DIN module
! map bioparams to local copies
  ae = bioparams(iae)
  mu_sp = bioparams(imu_sp)
  alpha_sp = bioparams(ialpha_sp)
  a_sp = bioparams(ia_sp)
  v_spn = bioparams(iv_spn)
  k_nh4sp = bioparams(ik_nh4sp)
  k_no3sp = bioparams(ik_no3sp)
  v_spp = bioparams(iv_spp)
  k_po4sp = bioparams(ik_po4sp)
  zeta = bioparams(izeta)
  theta = bioparams(itheta)
  r_excrsp_1 = bioparams(ir_excrsp_1)
  r_excrsp_2 = bioparams(ir_excrsp_2)
  r_pomsp = bioparams(ir_pomsp)
  mu_tr = bioparams(imu_tr)
  alpha_tr = bioparams(ialpha_tr)
  a_tr = bioparams(ia_tr)
  v_trn = bioparams(iv_trn)
  k_nh4tr = bioparams(ik_nh4tr)
  k_no3tr = bioparams(ik_no3tr)
  v_trp = bioparams(iv_trp)
  k_po4tr = bioparams(ik_po4tr)
  mu_picktrpo4 = bioparams(imu_picktrpo4)
  zeta_nf = bioparams(izeta_nf)
  r_excrtr_1 = bioparams(ir_excrtr_1)
  r_excrtr_n = bioparams(ir_excrtr_n)
  r_excrtr_2 = bioparams(ir_excrtr_2)
  r_pomtr = bioparams(ir_pomtr)
  mu_un = bioparams(imu_un)
  alpha_un = bioparams(ialpha_un)
  k_dom = bioparams(ik_dom)
!b_SDONlabi     = bioparams(ib_SDONlabi     )
!b_SDOPlabi     = bioparams(ib_SDOPlabi     )
  r_sdom = bioparams(ir_sdom)
  mu_ba = bioparams(imu_ba)
  b_baresp = bioparams(ib_baresp)
  r_baadju = bioparams(ir_baadju)
  r_baremi = bioparams(ir_baremi)
  r_barefr = bioparams(ir_barefr)
  f_baslct = bioparams(if_baslct)
  r_baresp_1 = bioparams(ir_baresp_1)
  r_baresp_min = bioparams(ir_baresp_min)
  r_baresp_max = bioparams(ir_baresp_max)
  r_bamort = bioparams(ir_bamort)
  mu_prt = bioparams(imu_prt)
  g_sp = bioparams(ig_sp)
  g_ba = bioparams(ig_ba)
  r_prtex = bioparams(ir_prtex)
  f_exprtldom = bioparams(if_exprtldom)
  r_prtresp_1 = bioparams(ir_prtresp_1)
  r_prtresp_2 = bioparams(ir_prtresp_2)
  r_prtadju = bioparams(ir_prtadju)
  r_prtremi = bioparams(ir_prtremi)
  r_pomprt = bioparams(ir_pomprt)
  mu_mz = bioparams(imu_mz)
  g_prt = bioparams(ig_prt)
  g_tr = bioparams(ig_tr)
  r_mzex = bioparams(ir_mzex)
  f_exmzldom = bioparams(if_exmzldom)
  r_mzresp_1 = bioparams(ir_mzresp_1)
  r_mzresp_2 = bioparams(ir_mzresp_2)
  r_mzadju = bioparams(ir_mzadju)
  r_mzremi = bioparams(ir_mzremi)
  r_mzpom = bioparams(ir_mzpom)
  r_mzrefr = bioparams(ir_mzrefr)
  r_mzremv = bioparams(ir_mzremv)
  f_hzsdom = bioparams(if_hzsdom)
  f_hzpom = bioparams(if_hzpom)
  r_sdomrefr = bioparams(ir_sdomrefr)
  q_refrdom_n = bioparams(iq_refrdom_n)
  q_refrdom_p = bioparams(iq_refrdom_p)
  q_pom_n = bioparams(iq_pom_n)
  q_pom_p = bioparams(iq_pom_p)
  r_nitrf = bioparams(ir_nitrf)
  remin_prf_n = bioparams(iremin_prf_n)
  remin_prf_p = bioparams(iremin_prf_p)
  remin = bioparams(iremin)
!-----------------------------------------------------------------------
!      Calculate terms used in the ecosystem model.
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!      Initialization
!-----------------------------------------------------------------------
!Fixed Parameters
! minimum [N,P]:C for SP
  q_sp_min_n = 0.034d0
  q_sp_min_p = 0.00188d0
! maximum [N,P]:C for SP
  q_sp_max_n = 0.17d0
  q_sp_max_p = 0.0169d0
! Redfield ratios
  q_sp_rdf_n = 0.15d0
  q_sp_rdf_p = 0.0094d0
  q_tr_min_n = 0.12d0
  q_tr_min_p = 0.001d0
  q_tr_max_n = 0.20d0
  q_tr_max_p = 0.0060d0
  q_tr_rdf_n = 0.16d0
  q_tr_rdf_p = 0.0035d0
  q_un_min_n = 0.12d0
  q_un_min_p = q_tr_min_p
  q_un_max_n = 0.20d0
  q_un_max_p = q_tr_max_p
  q_un_rdf_n = 0.16d0
  q_un_rdf_p = q_tr_rdf_p
  v_unn = v_spn
  k_nh4un = k_nh4sp
  k_no3un = k_no3sp
  v_unp = v_spp
  k_po4un = k_po4sp
  r_excrun_1 = r_excrsp_1
  r_excrun_n = r_excrtr_n
  r_excrun_2 = r_excrsp_2
  r_pomun = r_pomsp
! Optimal baterial [C, N, P]:C ratio
  q_ba_n = 0.18d0
  q_ba_p = 0.02d0
  g_un = g_sp
! Optimal protozoa [C, N, P]:C ratio
  q_prt_n = 0.2d0
  q_prt_p = 0.022d0
! Optimal metazoa [C, N, P]:C ratio
  q_mz_n = 0.2d0
  q_mz_p = 0.008d0
  a_un = a_sp
! Reference Temperature for Function of Temperatue Effects
  tref = 25.d0
! Temperature Effects
  tfunc = EXP(-(ae*(1/(tdat(iz, istep)+273.15)-1/(tref+273.15))))
  CALL PUSHREAL8(mu_sp)
  mu_sp = mu_sp*tfunc
  CALL PUSHREAL8(v_spn)
  v_spn = v_spn*tfunc
  CALL PUSHREAL8(v_spp)
  v_spp = v_spp*tfunc
  CALL PUSHREAL8(mu_tr)
  mu_tr = mu_tr*tfunc
  CALL PUSHREAL8(v_trn)
  v_trn = v_trn*tfunc
  CALL PUSHREAL8(v_trp)
  v_trp = v_trp*tfunc
  CALL PUSHREAL8(mu_un)
  mu_un = mu_un*tfunc
  CALL PUSHREAL8(v_unn)
  v_unn = v_unn*tfunc
  CALL PUSHREAL8(v_unp)
  v_unp = v_unp*tfunc
  CALL PUSHREAL8(mu_ba)
  mu_ba = mu_ba*tfunc
  CALL PUSHREAL8(mu_prt)
  mu_prt = mu_prt*tfunc
  CALL PUSHREAL8(r_baresp_1)
  r_baresp_1 = r_baresp_1*tfunc
  CALL PUSHREAL8(r_prtresp_1)
  r_prtresp_1 = r_prtresp_1*tfunc
  CALL PUSHREAL8(mu_mz)
  mu_mz = mu_mz*tfunc
  CALL PUSHREAL8(r_mzresp_1)
  r_mzresp_1 = r_mzresp_1*tfunc
!-----------------------------------------------------------------------
!      Microphytoplankton Processes
!-----------------------------------------------------------------------
! Nutrient quota Limitation
  nfunc_sp_n = (y(ispn)/y(ispc)-q_sp_min_n)/(q_sp_rdf_n-q_sp_min_n)
  nfunc_sp_p = (y(ispp)/y(ispc)-q_sp_min_p)/(q_sp_rdf_p-q_sp_min_p)
  IF (nfunc_sp_n .GT. nfunc_sp_p) THEN
    temp = nfunc_sp_p
    CALL PUSHINTEGER4(1)
  ELSE
    temp = nfunc_sp_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .GT. c1) THEN
    temp = c1
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  IF (temp .LT. c0) THEN
    temp = c0
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  pc_spmax = mu_sp*temp
! Light Limitation
  IF (pc_spmax .GT. c0 .AND. y(ispc) .GT. c0) THEN
    growspc = y(ispc)*pc_spmax*(c1-EXP(-(alpha_sp*y(ispchl)/y(ispc)*rlt/&
&      pc_spmax)))*EXP(-(a_sp*rlt))
    CALL PUSHINTEGER4(1)
  ELSE
    growspc = c0
    CALL PUSHINTEGER4(0)
  END IF
  IF (c0 .LT. (q_sp_max_n-y(ispn)/y(ispc))/(q_sp_max_n-q_sp_rdf_n)) THEN
    v_spmax_n = (q_sp_max_n-y(ispn)/y(ispc))/(q_sp_max_n-q_sp_rdf_n)
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    v_spmax_n = c0
  END IF
  IF (c1 .GT. v_spmax_n) THEN
    CALL PUSHINTEGER4(0)
    v_spmax_n = v_spmax_n
  ELSE
    v_spmax_n = c1
    CALL PUSHINTEGER4(1)
  END IF
  growspnh4 = y(ispc)*v_spn*v_spmax_n*y(inh4)/(y(inh4)+k_nh4sp+y(ino3)*&
&    k_nh4sp/k_no3sp)
  growspno3 = y(ispc)*v_spn*v_spmax_n*y(ino3)/(y(ino3)+k_no3sp+y(inh4)*&
&    k_no3sp/k_nh4sp)
  growspn = growspnh4 + growspno3
  IF (c0 .LT. (q_sp_max_p-y(ispp)/y(ispc))/(q_sp_max_p-q_sp_rdf_p)) THEN
    v_spmax_p = (q_sp_max_p-y(ispp)/y(ispc))/(q_sp_max_p-q_sp_rdf_p)
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    v_spmax_p = c0
  END IF
  IF (c1 .GT. v_spmax_p) THEN
    CALL PUSHINTEGER4(0)
    v_spmax_p = v_spmax_p
  ELSE
    v_spmax_p = c1
    CALL PUSHINTEGER4(1)
  END IF
! Chlorophyll
  IF (rlt .GT. c0) THEN
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! SP excretion (could be also considered as mortality)
! Passive
  IF (c1 - y(ispn)/y(ispc)/q_sp_rdf_n .LT. c1 - y(ispp)/y(ispc)/&
&      q_sp_rdf_p) THEN
    CALL PUSHREAL8(temp)
    temp = c1 - y(ispp)/y(ispc)/q_sp_rdf_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = c1 - y(ispn)/y(ispc)/q_sp_rdf_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .LT. c0) THEN
    max1 = c0
    CALL PUSHINTEGER4(1)
  ELSE
    max1 = temp
    CALL PUSHINTEGER4(0)
  END IF
  excrsp_2c = 0.5*y(ispc)*max1
  IF (excrsp_2c .GT. c0) THEN
    IF (c0 .LT. c1 - y(ispp)/y(ispn)/(q_sp_rdf_p/q_sp_rdf_n)) THEN
      temp = c1 - y(ispp)/y(ispn)/(q_sp_rdf_p/q_sp_rdf_n)
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHINTEGER4(0)
      temp = c0
    END IF
    IF (c0 .LT. c1 - y(ispn)/y(ispp)/(q_sp_rdf_n/q_sp_rdf_p)) THEN
      temp1 = c1 - y(ispn)/y(ispp)/(q_sp_rdf_n/q_sp_rdf_p)
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHINTEGER4(0)
      temp1 = c0
    END IF
    IF (0.25d0*y(ispn)*temp .GT. excrsp_2c*q_sp_rdf_n) THEN
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHINTEGER4(0)
    END IF
    IF (0.25d0*y(ispp)*temp1 .GT. excrsp_2c*q_sp_rdf_p) THEN
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHINTEGER4(0)
    END IF
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! Aggregation of SP
  pomspc = r_pomsp*y(ispc)*y(ispc)
  pomspn = pomspc*y(ispn)/y(ispc)
! SP grazed
  grazspc = mu_prt*y(iprtc)*y(ispc)*y(ispc)/(y(ispc)*y(ispc)+g_sp*g_sp+y&
&    (iunc)*y(iunc)/g_un/g_un*g_sp*g_sp+y(ibac)*y(ibac)/g_ba/g_ba*g_sp*&
&    g_sp)
  grazspn = grazspc*y(ispn)/y(ispc)
  grazspp = grazspc*y(ispp)/y(ispc)
! SP derivs
!-----------------------------------------------------------------------
!      Trichodesmium Processes
!-----------------------------------------------------------------------
! Primary Production
! Nutrient quota Limitation
  nfunc_tr_n = (y(itrn)/y(itrc)-q_tr_min_n)/(q_tr_rdf_n-q_tr_min_n)
  nfunc_tr_p = (y(itrp)/y(itrc)-q_tr_min_p)/(q_tr_rdf_p-q_tr_min_p)
  IF (nfunc_tr_n .GT. nfunc_tr_p) THEN
    CALL PUSHREAL8(temp)
    temp = nfunc_tr_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = nfunc_tr_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .GT. c1) THEN
    temp = c1
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  IF (temp .LT. c0) THEN
    temp = c0
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  pc_trmax = mu_tr*temp
! Light Limitation
  IF (pc_trmax .GT. c0 .AND. y(itrc) .GT. c0) THEN
    growtrc = y(itrc)*pc_trmax*(c1-EXP(-(alpha_tr*y(itrchl)/y(itrc)*rlt/&
&      pc_trmax)))*EXP(-(a_tr*rlt))
    CALL PUSHINTEGER4(1)
  ELSE
    growtrc = c0
    CALL PUSHINTEGER4(0)
  END IF
  IF (c0 .LT. (q_tr_max_n-y(itrn)/y(itrc))/(q_tr_max_n-q_tr_rdf_n)) THEN
    v_trmax_n = (q_tr_max_n-y(itrn)/y(itrc))/(q_tr_max_n-q_tr_rdf_n)
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    v_trmax_n = c0
  END IF
  IF (c1 .GT. v_trmax_n) THEN
    CALL PUSHINTEGER4(0)
    v_trmax_n = v_trmax_n
  ELSE
    v_trmax_n = c1
    CALL PUSHINTEGER4(1)
  END IF
  growtrnh4 = y(itrc)*v_trn*v_trmax_n*y(inh4)/(y(inh4)+k_nh4tr+y(ino3)*&
&    k_nh4tr/k_no3tr)
  growtrno3 = y(itrc)*v_trn*v_trmax_n*y(ino3)/(y(ino3)+k_no3tr+y(inh4)*&
&    k_no3tr/k_nh4tr)
  IF (tdat(iz, istep) .LT. 20.0) THEN
    CALL PUSHINTEGER4(0)
    maxtrnf = c0
  ELSE
    y1 = ((y(itrc)+growtrc-growtrno3*zeta)*q_tr_max_n-y(itrn)-growtrno3-&
&      growtrnh4)/(c1+zeta_nf*q_tr_max_n)*v_trmax_n*tfunc
    IF (c0 .LT. y1) THEN
      maxtrnf = y1
      CALL PUSHINTEGER4(2)
    ELSE
      maxtrnf = c0
      CALL PUSHINTEGER4(1)
    END IF
  END IF
  IF (y(itrc)*v_trn*v_trmax_n .GT. growtrnh4 + growtrno3 + maxtrnf) THEN
    growtrn = growtrnh4 + growtrno3 + maxtrnf
    CALL PUSHINTEGER4(1)
  ELSE
    growtrn = y(itrc)*v_trn*v_trmax_n
    CALL PUSHINTEGER4(0)
  END IF
  growtrnf = growtrn - growtrnh4 - growtrno3
  IF (c0 .LT. (q_tr_max_p-y(itrp)/y(itrc))/(q_tr_max_p-q_tr_rdf_p)) THEN
    v_trmax_p = (q_tr_max_p-y(itrp)/y(itrc))/(q_tr_max_p-q_tr_rdf_p)
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    v_trmax_p = c0
  END IF
  IF (c1 .GT. v_trmax_p) THEN
    CALL PUSHINTEGER4(0)
    v_trmax_p = v_trmax_p
  ELSE
    v_trmax_p = c1
    CALL PUSHINTEGER4(1)
  END IF
  IF (y(itrc)*(q_tr_max_p+q_tr_rdf_p)/2 - y(itrp) .LT. c0) THEN
    CALL PUSHINTEGER4(0)
    max2 = c0
  ELSE
    max2 = y(itrc)*(q_tr_max_p+q_tr_rdf_p)/2 - y(itrp)
    CALL PUSHINTEGER4(1)
  END IF
! Respiration
! Chlorophyll
  IF (rlt .GT. c0) THEN
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! TR excretion (mortality)
! Passive
  IF (c1 .GT. nfunc_tr_n) THEN
    min3 = nfunc_tr_n
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    min3 = c1
  END IF
  IF (c1 .GT. nfunc_tr_n) THEN
    min4 = nfunc_tr_n
    CALL PUSHINTEGER4(1)
  ELSE
    min4 = c1
    CALL PUSHINTEGER4(0)
  END IF
  IF (c1 - y(itrn)/y(itrc)/q_tr_rdf_n .LT. c1 - y(itrp)/y(itrc)/&
&      q_tr_rdf_p) THEN
    CALL PUSHREAL8(temp)
    temp = c1 - y(itrp)/y(itrc)/q_tr_rdf_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = c1 - y(itrn)/y(itrc)/q_tr_rdf_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .LT. c0) THEN
    max3 = c0
    CALL PUSHINTEGER4(1)
  ELSE
    max3 = temp
    CALL PUSHINTEGER4(0)
  END IF
  excrtr_2c = r_excrtr_2*y(itrc)*max3
  IF (excrtr_2c .GT. c0) THEN
    IF (c0 .LT. c1 - y(itrp)/y(itrn)/(q_tr_rdf_p/q_tr_rdf_n)) THEN
      temp = c1 - y(itrp)/y(itrn)/(q_tr_rdf_p/q_tr_rdf_n)
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHINTEGER4(0)
      temp = c0
    END IF
    IF (c0 .LT. c1 - y(itrn)/y(itrp)/(q_tr_rdf_n/q_tr_rdf_p)) THEN
      CALL PUSHREAL8(temp1)
      temp1 = c1 - y(itrn)/y(itrp)/(q_tr_rdf_n/q_tr_rdf_p)
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHREAL8(temp1)
      temp1 = c0
      CALL PUSHINTEGER4(0)
    END IF
    IF (0.25d0*y(itrn)*temp .GT. excrtr_2c*q_tr_rdf_n) THEN
      min5 = excrtr_2c*q_tr_rdf_n
      CALL PUSHINTEGER4(1)
    ELSE
      min5 = 0.25d0*y(itrn)*temp
      CALL PUSHINTEGER4(0)
    END IF
    IF (0.25d0*y(itrp)*temp1 .GT. excrtr_2c*q_tr_rdf_p) THEN
      min6 = excrtr_2c*q_tr_rdf_p
      CALL PUSHINTEGER4(1)
    ELSE
      min6 = 0.25d0*y(itrp)*temp1
      CALL PUSHINTEGER4(0)
    END IF
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! Aggregation of TR
  pomtrc = r_pomtr*y(itrc)*y(itrc)
! TR grazed
  graztrc = mu_mz*y(imzc)*y(itrc)*y(itrc)/(y(itrc)*y(itrc)+g_tr*g_tr+y(&
&    iprtc)*y(iprtc)/g_prt/g_prt*g_tr*g_tr)
  graztrn = graztrc*y(itrn)/y(itrc)
  graztrp = graztrc*y(itrp)/y(itrc)
! New TR
!-----------------------------------------------------------------------
!      Unicellular N2-fixers Processes
!-----------------------------------------------------------------------
! Primary Production
! Nutrient quota Limitation
  nfunc_un_n = (y(iunn)/y(iunc)-q_un_min_n)/(q_un_rdf_n-q_un_min_n)
  nfunc_un_p = (y(iunp)/y(iunc)-q_un_min_p)/(q_un_rdf_p-q_un_min_p)
  IF (nfunc_un_n .GT. nfunc_un_p) THEN
    CALL PUSHREAL8(temp)
    temp = nfunc_un_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = nfunc_un_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .GT. c1) THEN
    temp = c1
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  IF (temp .LT. c0) THEN
    temp = c0
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  pc_unmax = mu_un*temp
! Light Limitation
  IF (pc_unmax .GT. c0 .AND. y(iunc) .GT. c0) THEN
    growunc = y(iunc)*pc_unmax*(c1-EXP(-(alpha_un*y(iunchl)/y(iunc)*rlt/&
&      pc_unmax)))*EXP(-(a_un*rlt))
    CALL PUSHINTEGER4(1)
  ELSE
    growunc = c0
    CALL PUSHINTEGER4(0)
  END IF
  IF (c0 .LT. (q_un_max_n-y(iunn)/y(iunc))/(q_un_max_n-q_un_rdf_n)) THEN
    v_unmax_n = (q_un_max_n-y(iunn)/y(iunc))/(q_un_max_n-q_un_rdf_n)
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    v_unmax_n = c0
  END IF
  IF (c1 .GT. v_unmax_n) THEN
    CALL PUSHINTEGER4(0)
    v_unmax_n = v_unmax_n
  ELSE
    v_unmax_n = c1
    CALL PUSHINTEGER4(1)
  END IF
  growunnh4 = y(iunc)*v_unn*v_unmax_n*y(inh4)/(y(inh4)+k_nh4un+y(ino3)*&
&    k_nh4un/k_no3un)
  growunno3 = y(iunc)*v_unn*v_unmax_n*y(ino3)/(y(ino3)+k_no3un+y(inh4)*&
&    k_no3un/k_nh4un)
  y2 = ((y(iunc)-growunc-growunno3*zeta)*q_un_max_n-y(iunn)-growunno3-&
&    growunnh4)/(c1+zeta_nf*q_un_max_n)*v_unmax_n*tfunc
  IF (c0 .LT. y2) THEN
    maxunnf = y2
    CALL PUSHINTEGER4(1)
  ELSE
    maxunnf = c0
    CALL PUSHINTEGER4(0)
  END IF
  IF (y(iunc)*v_unn*v_unmax_n .GT. growunnh4 + growunno3 + maxunnf) THEN
    growunn = growunnh4 + growunno3 + maxunnf
    CALL PUSHINTEGER4(1)
  ELSE
    growunn = y(iunc)*v_unn*v_unmax_n
    CALL PUSHINTEGER4(0)
  END IF
  growunnf = growunn - growunnh4 - growunno3
  IF (c0 .LT. (q_un_max_p-y(iunp)/y(iunc))/(q_un_max_p-q_un_rdf_p)) THEN
    v_unmax_p = (q_un_max_p-y(iunp)/y(iunc))/(q_un_max_p-q_un_rdf_p)
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    v_unmax_p = c0
  END IF
  IF (c1 .GT. v_unmax_p) THEN
    CALL PUSHINTEGER4(0)
    v_unmax_p = v_unmax_p
  ELSE
    v_unmax_p = c1
    CALL PUSHINTEGER4(1)
  END IF
! Chlorophyll
  IF (rlt .GT. c0) THEN
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! UN excretion
! Passive
  IF (c1 .GT. nfunc_un_n) THEN
    min7 = nfunc_un_n
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    min7 = c1
  END IF
  IF (c1 .GT. nfunc_un_n) THEN
    min8 = nfunc_un_n
    CALL PUSHINTEGER4(1)
  ELSE
    min8 = c1
    CALL PUSHINTEGER4(0)
  END IF
  IF (c1 - y(iunn)/y(iunc)/q_un_rdf_n .LT. c1 - y(iunp)/y(iunc)/&
&      q_un_rdf_p) THEN
    CALL PUSHREAL8(temp)
    temp = c1 - y(iunp)/y(iunc)/q_un_rdf_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = c1 - y(iunn)/y(iunc)/q_un_rdf_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .LT. c0) THEN
    max4 = c0
    CALL PUSHINTEGER4(1)
  ELSE
    max4 = temp
    CALL PUSHINTEGER4(0)
  END IF
  excrun_2c = r_excrun_2*y(iunc)*max4
  IF (excrun_2c .GT. c0) THEN
    IF (c0 .LT. c1 - y(iunp)/y(iunn)/(q_un_rdf_p/q_un_rdf_n)) THEN
      temp = c1 - y(iunp)/y(iunn)/(q_un_rdf_p/q_un_rdf_n)
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHINTEGER4(0)
      temp = c0
    END IF
    IF (c0 .LT. c1 - y(iunn)/y(iunp)/(q_un_rdf_n/q_un_rdf_p)) THEN
      CALL PUSHREAL8(temp1)
      temp1 = c1 - y(iunn)/y(iunp)/(q_un_rdf_n/q_un_rdf_p)
      CALL PUSHINTEGER4(1)
    ELSE
      CALL PUSHREAL8(temp1)
      temp1 = c0
      CALL PUSHINTEGER4(0)
    END IF
    IF (0.25d0*y(iunn)*temp .GT. excrun_2c*q_un_rdf_n) THEN
      min9 = excrun_2c*q_un_rdf_n
      CALL PUSHINTEGER4(1)
    ELSE
      min9 = 0.25d0*y(iunn)*temp
      CALL PUSHINTEGER4(0)
    END IF
    IF (0.25d0*y(iunp)*temp1 .GT. excrun_2c*q_un_rdf_p) THEN
      min10 = excrun_2c*q_un_rdf_p
      CALL PUSHINTEGER4(1)
    ELSE
      min10 = 0.25d0*y(iunp)*temp1
      CALL PUSHINTEGER4(0)
    END IF
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! Aggregation of UN
  pomunc = r_pomun*y(iunc)*y(iunc)
! UN grazed
  grazunc = mu_prt*y(iprtc)*y(iunc)*y(iunc)/(y(iunc)*y(iunc)+g_un*g_un+y&
&    (ispc)*y(ispc)/g_sp/g_sp*g_un*g_un+y(ibac)*y(ibac)/g_ba/g_ba*g_un*&
&    g_un)
  grazunn = grazunc*y(iunn)/y(iunc)
  grazunp = grazunc*y(iunp)/y(iunc)
! New UN
!-----------------------------------------------------------------------
!      Bacterial Processes
!-----------------------------------------------------------------------
! 1. Gross Grow
! Maximum possible C amount for bacterial use
  alc = y(ildomc)
!temp = MIN(c1, exp(b_SDONlabi * (y(iSDOMn)/y(iSDOMc)/q_BA_n - c1)) )
!temp = MIN(temp, exp(b_SDOPlabi * (y(iSDOMp)/y(iSDOMc)/q_BA_p - c1)) )
  asc = y(isdomc)*r_sdom
! Carbon Usage
  nfunc_ba_n = y(iban)/y(ibac)/q_ba_n
  nfunc_ba_p = y(ibap)/y(ibac)/q_ba_p
  IF (nfunc_ba_n .GT. nfunc_ba_p) THEN
    CALL PUSHREAL8(temp)
    temp = nfunc_ba_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = nfunc_ba_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .GT. c1) THEN
    temp = c1
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  growbaldoc = mu_ba*y(ibac)*temp*alc/(alc+k_dom+asc)
  growbasdoc = mu_ba*y(ibac)*temp*asc/(asc+k_dom+alc)
! DON and DOP usage
! available labile N
  growbaldon = growbaldoc/y(ildomc)*y(ildomn)
! available labile P
  growbaldop = growbaldoc/y(ildomc)*y(ildomp)
  y3 = y(isdomn)/y(isdomc) + f_baslct/nfunc_ba_n*(q_ba_n-y(isdomn)/y(&
&    isdomc))
  IF (q_ba_n .GT. y3) THEN
    min11 = y3
    CALL PUSHINTEGER4(1)
  ELSE
    min11 = q_ba_n
    CALL PUSHINTEGER4(0)
  END IF
  growbasdon = growbasdoc*min11
  y4 = y(isdomp)/y(isdomc) + f_baslct/nfunc_ba_p*(q_ba_p-y(isdomp)/y(&
&    isdomc))
  IF (q_ba_p .GT. y4) THEN
    min12 = y4
    CALL PUSHINTEGER4(1)
  ELSE
    min12 = q_ba_p
    CALL PUSHINTEGER4(0)
  END IF
  IF (c1 .GT. 1/nfunc_ba_n) THEN
    min13 = 1/nfunc_ba_n
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    min13 = c1
  END IF
! inorganic nutrients uptake
  growbanh4 = growbaldon/y(ildomn)*y(inh4)*min13
  IF (nfunc_ba_n .LT. c1) THEN
    IF (c1 .GT. 1/nfunc_ba_n) THEN
      min15 = 1/nfunc_ba_n
      CALL PUSHINTEGER4(1)
    ELSE
      min15 = c1
      CALL PUSHINTEGER4(0)
    END IF
    x1 = 0.1*(growbaldon+growbasdon)/(y(ildomn)+y(isdomn))*y(ino3)*min15
    IF (x1 .GT. (growbaldon+growbasdon)/(y(ildomn)+y(isdomn))*(y(ino3)+y&
&        (inh4)) - growbanh4) THEN
      growbano3 = (growbaldon+growbasdon)/(y(ildomn)+y(isdomn))*(y(ino3)&
&        +y(inh4)) - growbanh4
      CALL PUSHINTEGER4(0)
    ELSE
      growbano3 = x1
      CALL PUSHINTEGER4(1)
    END IF
    IF (c0 .LT. growbano3) THEN
      CALL PUSHINTEGER4(1)
      growbano3 = growbano3
    ELSE
      growbano3 = c0
      CALL PUSHINTEGER4(2)
    END IF
  ELSE
    growbano3 = c0
    CALL PUSHINTEGER4(0)
  END IF
  IF (c1 .GT. 1/nfunc_ba_p) THEN
    min14 = 1/nfunc_ba_p
    CALL PUSHINTEGER4(1)
  ELSE
    min14 = c1
    CALL PUSHINTEGER4(0)
  END IF
! Bacteria gross growth
  growbac = growbaldoc + growbasdoc
! 2. respiration
! 3. excreting refractory DOM
  refrbac = r_barefr*y(ibac)
! 4. excreting semi-labile DOM and regenerating DIN
  IF (y(ibac) .LT. y(iban)/q_ba_n .AND. y(ibac) .LT. y(ibap)/q_ba_p) &
&  THEN
    CALL PUSHINTEGER4(2)
  ELSE IF (y(ibac) .GT. y(iban)/q_ba_n .AND. y(ibap)/q_ba_p .GT. y(iban)&
&      /q_ba_n) THEN
    CALL PUSHINTEGER4(0)
  ELSE
    CALL PUSHINTEGER4(1)
  END IF
!6. removal by grazing
  grazbac = mu_prt*y(iprtc)*y(ibac)*y(ibac)/(y(ibac)*y(ibac)+g_ba*g_ba+y&
&    (ispc)*y(ispc)/g_sp/g_sp*g_ba*g_ba+y(iunc)*y(iunc)/g_un/g_un*g_ba*&
&    g_ba)
  grazban = grazbac/y(ibac)*y(iban)
  grazbap = grazbac/y(ibac)*y(ibap)
!6b. Mortality due to viruses
!7. BA Derivs
!8. Flux of inorganic nutrients through bacteria
!-----------------------------------------------------------------------
!      Protozoan Processes
!-----------------------------------------------------------------------
! 1. gross growth
  growprtc = grazspc + grazbac + grazunc
  growprtn = grazspn + grazban + grazunn
  growprtp = grazspp + grazbap + grazunp
! 2. DOM excretion
!                                * EXP(3*(y(iPRTn)/y(iPRTc)/q_PRT_n-c1))
!                               * EXP(3*(y(iPRTp)/y(iPRTc)/q_PRT_p-c1))
! 3. respiration
  IF (c1 - y(iprtn)/y(iprtc)/q_prt_n .LT. c1 - y(iprtp)/y(iprtc)/q_prt_p&
&  ) THEN
    CALL PUSHREAL8(temp)
    temp = c1 - y(iprtp)/y(iprtc)/q_prt_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = c1 - y(iprtn)/y(iprtc)/q_prt_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (c0 .LT. temp) THEN
    CALL PUSHINTEGER4(0)
    temp = temp
  ELSE
    temp = c0
    CALL PUSHINTEGER4(1)
  END IF
  excrprtsdom2c = r_prtadju*y(iprtc)*temp
  IF (r_prtremi*(y(iprtn)-q_prt_n*y(iprtc)) .LT. r_prtremi*(y(iprtn)-&
&      q_prt_n/q_prt_p*y(iprtp))) THEN
    remiprtn = r_prtremi*(y(iprtn)-q_prt_n/q_prt_p*y(iprtp))
    CALL PUSHINTEGER4(1)
  ELSE
    remiprtn = r_prtremi*(y(iprtn)-q_prt_n*y(iprtc))
    CALL PUSHINTEGER4(0)
  END IF
  IF (c0 .LT. remiprtn) THEN
    CALL PUSHINTEGER4(0)
  ELSE
    CALL PUSHINTEGER4(1)
  END IF
  IF (r_prtremi*(y(iprtp)-q_prt_p*y(iprtc)) .LT. r_prtremi*(y(iprtp)-&
&      q_prt_p/q_prt_n*y(iprtn))) THEN
    remiprtp = r_prtremi*(y(iprtp)-q_prt_p/q_prt_n*y(iprtn))
    CALL PUSHINTEGER4(1)
  ELSE
    remiprtp = r_prtremi*(y(iprtp)-q_prt_p*y(iprtc))
    CALL PUSHINTEGER4(0)
  END IF
  IF (c0 .LT. remiprtp) THEN
    CALL PUSHINTEGER4(0)
  ELSE
    CALL PUSHINTEGER4(1)
  END IF
! POM production
  pomprtc = r_pomprt*growprtc
! 6. removal by microzooplankton
  grazprtc = mu_mz*y(imzc)*y(iprtc)*y(iprtc)/(y(iprtc)*y(iprtc)+g_prt*&
&    g_prt+y(itrc)*y(itrc)/g_tr/g_tr*g_prt*g_prt)
  grazprtn = grazprtc*y(iprtn)/y(iprtc)
  grazprtp = grazprtc*y(iprtp)/y(iprtc)
! 7. new PRT
!-----------------------------------------------------------------------
!      Metozoan Processes
!-----------------------------------------------------------------------
! 1. gross growth
  growmzc = grazprtc + graztrc
  growmzn = grazprtn + graztrn
  growmzp = grazprtp + graztrp
! 2. DOM excretion
!                                   * EXP(3*(y(iMZn)/y(iMZc)/q_MZ_n-c1)) 
!                                   * EXP(3*(y(iMZp)/y(iMZc)/q_MZ_p-c1))
! 3. respiration
  IF (c1 - y(imzn)/y(imzc)/q_mz_n .LT. c1 - y(imzp)/y(imzc)/q_mz_p) THEN
    CALL PUSHREAL8(temp)
    temp = c1 - y(imzp)/y(imzc)/q_mz_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = c1 - y(imzn)/y(imzc)/q_mz_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .LT. c0) THEN
    temp = c0
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
    temp = temp
  END IF
  excrmzsdom2c = r_mzadju*y(imzc)*temp
  IF (r_mzremi*(y(imzn)-q_mz_n*y(imzc)) .LT. r_mzremi*(y(imzn)-q_mz_n/&
&      q_mz_p*y(imzp))) THEN
    remimzn = r_mzremi*(y(imzn)-q_mz_n/q_mz_p*y(imzp))
    CALL PUSHINTEGER4(1)
  ELSE
    remimzn = r_mzremi*(y(imzn)-q_mz_n*y(imzc))
    CALL PUSHINTEGER4(0)
  END IF
  IF (remimzn .LT. c0) THEN
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
  IF (r_mzremi*(y(imzp)-q_mz_p*y(imzc)) .LT. r_mzremi*(y(imzp)-q_mz_p/&
&      q_mz_n*y(imzn))) THEN
    remimzp = r_mzremi*(y(imzp)-q_mz_p/q_mz_n*y(imzn))
    CALL PUSHINTEGER4(1)
  ELSE
    remimzp = r_mzremi*(y(imzp)-q_mz_p*y(imzc))
    CALL PUSHINTEGER4(0)
  END IF
  IF (remimzp .LT. c0) THEN
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
! 6. indissolved POM and refractory DOM production
  pommzc = r_mzpom*growmzc
  refrmzc = r_mzrefr*growmzc
! 7. removal by higher-level zooplankton
  remvmzc = r_mzremv*y(imzc)*y(imzc)
  remvmzn = remvmzc/y(imzc)*y(imzn)
  remvmzp = remvmzc/y(imzc)*y(imzp)
! 8. new MZ
!-----------------------------------------------------------------------
!      Detritus Processes
!-----------------------------------------------------------------------
!-----------------------------------------------------------------------
!      Inorganic Nutrients Processes
!-----------------------------------------------------------------------
  IF (y(isdomn)/y(isdomc)/q_refrdom_n .GT. y(isdomp)/y(isdomc)/&
&      q_refrdom_p) THEN
    CALL PUSHREAL8(temp)
    temp = y(isdomp)/y(isdomc)/q_refrdom_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = y(isdomn)/y(isdomc)/q_refrdom_n
    CALL PUSHINTEGER4(0)
  END IF
  refrsdomc = r_sdomrefr*y(isdomc)*EXP(c1-temp)
  IF (y(isdomc) - y(isdomn)/q_refrdom_n .LT. y(isdomc) - y(isdomp)/&
&      q_refrdom_p) THEN
    CALL PUSHREAL8(temp)
    temp = y(isdomc) - y(isdomp)/q_refrdom_p
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHREAL8(temp)
    temp = y(isdomc) - y(isdomn)/q_refrdom_n
    CALL PUSHINTEGER4(0)
  END IF
  IF (temp .LT. c0) THEN
    CALL PUSHINTEGER4(1)
  ELSE
    CALL PUSHINTEGER4(0)
  END IF
  growbacb = dydtt_diagb(iprbac)/secperday
  respbab = -(dydtt_diagb(iprbac)/secperday)
  dydtt_diagb(iprbac) = 0.D0
  temp97b19 = 12.d0*dydtt_diagb(ipp)/secperday
  growspcb = temp97b19
  growtrcb = temp97b19
  growuncb = temp97b19
  respspb = -temp97b19
  resptrb = -temp97b19
  respunb = -temp97b19
  temp97b20 = dydttb(isdomp)/secperday
  dydttb(isdomp) = 0.D0
  temp97b21 = dydttb(isdomn)/secperday
  dydttb(isdomn) = 0.D0
  temp97b22 = dydttb(isdomc)/secperday
  dydttb(isdomc) = 0.D0
  temp97b23 = dydttb(ildomp)/secperday
  dydttb(ildomp) = 0.D0
  temp97b24 = dydttb(ildomn)/secperday
  dydttb(ildomn) = 0.D0
  temp97b25 = dydttb(ildomc)/secperday
  excrsp_1cb = temp97b25 - temp97b19
  excrtr_1cb = temp97b25 - temp97b19
  excrun_1cb = temp97b25 - temp97b19
  excrsp_2cb = temp97b22 - temp97b19
  excrtr_2cb = temp97b22 - temp97b19
  excrun_2cb = temp97b22 - temp97b19
  dydtt_diagb(ipp) = 0.D0
  excrsp_2pb = temp97b20
  excrtr_2pb = temp97b20
  excrun_2pb = temp97b20
  excrbapb = temp97b20
  excrprtsdompb = temp97b20
  excrprtsdom2pb = temp97b20
  excrmzsdompb = temp97b20
  excrmzsdom2pb = temp97b20
  excrhzsdompb = temp97b20
  disdetpb = temp97b20
  growbasdopb = -temp97b20
  refrsdompb = -temp97b20
  excrsp_2nb = temp97b21
  excrtr_2nb = temp97b21
  excrun_2nb = temp97b21
  excrbanb = temp97b21
  excrprtsdomnb = temp97b21
  excrprtsdom2nb = temp97b21
  excrmzsdomnb = temp97b21
  excrmzsdom2nb = temp97b21
  excrhzsdomnb = temp97b21
  disdetnb = temp97b21
  growbasdonb = -temp97b21
  refrsdomnb = -temp97b21
  excrbacb = temp97b22
  excrprtsdomcb = temp97b22
  excrprtsdom2cb = temp97b22
  excrmzsdomcb = temp97b22
  excrmzsdom2cb = temp97b22
  excrhzsdomcb = temp97b22
  disdetcb = temp97b22
  growbasdocb = -temp97b22
  refrsdomcb = -temp97b22
  excrsp_1pb = temp97b23
  excrtr_1pb = temp97b23
  excrun_1pb = temp97b23
  excrprtldompb = temp97b23
  excrmzldompb = temp97b23
  growbaldopb = -temp97b23
  mortbapb = temp97b23
  excrsp_1nb = temp97b24
  excrtr_1nb = temp97b24
  excrun_1nb = temp97b24
  excrprtldomnb = temp97b24
  excrmzldomnb = temp97b24
  growbaldonb = -temp97b24
  mortbanb = temp97b24
  excrprtldomcb = temp97b25
  excrmzldomcb = temp97b25
  growbaldocb = -temp97b25
  mortbacb = temp97b25
  dydttb(ildomc) = 0.D0
  tempb = refrsdomcb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    yb(isdomc) = yb(isdomc) + tempb
    yb(isdomn) = yb(isdomn) - tempb/q_refrdom_n
    q_refrdom_nb = y(isdomn)*tempb/q_refrdom_n**2
    q_refrdom_pb = 0.D0
  ELSE
    CALL POPREAL8(temp)
    yb(isdomc) = yb(isdomc) + tempb
    yb(isdomp) = yb(isdomp) - tempb/q_refrdom_p
    q_refrdom_pb = y(isdomp)*tempb/q_refrdom_p**2
    q_refrdom_nb = 0.D0
  END IF
  refrsdomcb = refrsdomcb + q_refrdom_n*refrsdomnb + q_refrdom_p*&
&    refrsdompb
  q_refrdom_pb = q_refrdom_pb + refrsdomc*refrsdompb
  q_refrdom_nb = q_refrdom_nb + refrsdomc*refrsdomnb
  temp97b18 = EXP(c1-temp)*refrsdomcb
  r_sdomrefrb = y(isdomc)*temp97b18
  yb(isdomc) = yb(isdomc) + r_sdomrefr*temp97b18
  tempb = -(r_sdomrefr*y(isdomc)*EXP(c1-temp)*refrsdomcb)
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    temp97b14 = tempb/(y(isdomc)*q_refrdom_n)
    temp97b15 = -(y(isdomn)*temp97b14/(y(isdomc)*q_refrdom_n))
    yb(isdomn) = yb(isdomn) + temp97b14
    yb(isdomc) = yb(isdomc) + q_refrdom_n*temp97b15
    q_refrdom_nb = q_refrdom_nb + y(isdomc)*temp97b15
  ELSE
    CALL POPREAL8(temp)
    temp97b16 = tempb/(y(isdomc)*q_refrdom_p)
    temp97b17 = -(y(isdomp)*temp97b16/(y(isdomc)*q_refrdom_p))
    yb(isdomp) = yb(isdomp) + temp97b16
    yb(isdomc) = yb(isdomc) + q_refrdom_p*temp97b17
    q_refrdom_pb = q_refrdom_pb + y(isdomc)*temp97b17
  END IF
  temp97b3 = dydttb(ipo4)/secperday
  remiprtpb = temp97b3
  dydttb(ipo4) = 0.D0
  temp97b4 = dydttb(ino3)/secperday
  dydttb(ino3) = 0.D0
  temp97b5 = dydttb(inh4)/secperday
  dydttb(inh4) = 0.D0
  temp97b6 = dydttb(idetp)/secperday
  dydttb(idetp) = 0.D0
  temp97b7 = dydttb(idetn)/secperday
  dydttb(idetn) = 0.D0
  temp97b8 = dydttb(idetc)/secperday
  dydttb(idetc) = 0.D0
  temp97b9 = dydttb(imzp)/secperday
  remimzpb = temp97b3 - temp97b9
  remihzpb = temp97b3
  growsppb = -temp97b3
  growtrpo4b = -temp97b3
  growunpb = -temp97b3
  fluxbapo4b = -temp97b3
  nitrfb = temp97b4 - temp97b5
  growtrno3b = -temp97b4
  growunno3b = -temp97b4
  growspno3b = -temp97b4
  fluxbano3b = -temp97b4
  remiprtnb = temp97b5
  dydttb(imzp) = 0.D0
  temp97b10 = dydttb(imzn)/secperday
  remimznb = temp97b5 - temp97b10
  remihznb = temp97b5
  excrtr_nh4b = temp97b5
  excrun_nh4b = temp97b5
  growspnh4b = -temp97b5
  growtrnh4b = -temp97b5
  growunnh4b = -temp97b5
  fluxbanh4b = -temp97b5
  r_nitrfb = y(inh4)*nitrfb
  yb(inh4) = yb(inh4) + r_nitrf*nitrfb
  pomsppb = temp97b6
  pomtrpb = temp97b6
  pomunpb = temp97b6
  pomprtpb = temp97b6
  pommzpb = temp97b6 - temp97b9
  pomhzpb = temp97b6 - remihzpb
  disdetpb = disdetpb - temp97b6
  pomspnb = temp97b7
  pomtrnb = temp97b7
  pomunnb = temp97b7
  pomprtnb = temp97b7
  pommznb = temp97b7 - temp97b10
  pomhznb = temp97b7 - remihznb
  disdetnb = disdetnb - temp97b7
  pomspcb = temp97b8
  pomtrcb = temp97b8
  pomuncb = temp97b8
  pomprtcb = temp97b8
  dydttb(imzn) = 0.D0
  temp97b11 = dydttb(imzc)/secperday
  pommzcb = q_pom_n*pommznb + q_pom_p*pommzpb - temp97b11 + temp97b8
  pomhzcb = temp97b8
  disdetcb = disdetcb - temp97b8
  yb(idetp) = yb(idetp) + remin*remin_prf_p*disdetpb
  reminb = y(idetc)*disdetcb + y(idetn)*remin_prf_n*disdetnb + y(idetp)*&
&    remin_prf_p*disdetpb
  remin_prf_pb = y(idetp)*remin*disdetpb
  yb(idetn) = yb(idetn) + remin*remin_prf_n*disdetnb
  remin_prf_nb = y(idetn)*remin*disdetnb
  yb(idetc) = yb(idetc) + remin*disdetcb
  growmzpb = temp97b9
  excrmzldompb = excrmzldompb - temp97b9
  excrmzsdompb = excrmzsdompb - temp97b9
  excrmzsdom2pb = excrmzsdom2pb - temp97b9
  refrmzpb = -temp97b9
  excrhzsdompb = excrhzsdompb - remihzpb
  remvmzpb = f_hzpom*pomhzpb + f_hzsdom*excrhzsdompb + remihzpb - &
&    temp97b9
  growmznb = temp97b10
  excrmzldomnb = excrmzldomnb - temp97b10
  excrmzsdomnb = excrmzsdomnb - temp97b10
  excrmzsdom2nb = excrmzsdom2nb - temp97b10
  refrmznb = -temp97b10
  excrhzsdomnb = excrhzsdomnb - remihznb
  remvmznb = f_hzpom*pomhznb + f_hzsdom*excrhzsdomnb + remihznb - &
&    temp97b10
  refrmzcb = q_refrdom_n*refrmznb + q_refrdom_p*refrmzpb - temp97b11
  growmzcb = r_mzpom*pommzcb + r_mzrefr*refrmzcb + temp97b11
  excrmzldomcb = excrmzldomcb - temp97b11
  excrmzsdomcb = excrmzsdomcb - temp97b11
  excrmzsdom2cb = excrmzsdom2cb - temp97b11
  temp97b12 = remvmzpb/y(imzc)
  temp97b13 = remvmznb/y(imzc)
  remvmzcb = y(imzn)*temp97b13 + y(imzp)*temp97b12 + f_hzpom*pomhzcb + &
&    f_hzsdom*excrhzsdomcb - temp97b11
  respmzb = -temp97b11
  dydttb(imzc) = 0.D0
  f_hzsdomb = remvmzc*excrhzsdomcb + remvmzn*excrhzsdomnb + remvmzp*&
&    excrhzsdompb
  f_hzpomb = remvmzc*pomhzcb + remvmzn*pomhznb + remvmzp*pomhzpb
  yb(imzp) = yb(imzp) + remvmzc*temp97b12
  yb(imzc) = yb(imzc) - remvmzc*y(imzp)*temp97b12/y(imzc)
  yb(imzn) = yb(imzn) + remvmzc*temp97b13
  yb(imzc) = yb(imzc) + r_mzremv*2*y(imzc)*remvmzcb - remvmzc*y(imzn)*&
&    temp97b13/y(imzc)
  r_mzremvb = y(imzc)**2*remvmzcb
  q_refrdom_pb = q_refrdom_pb + refrmzc*refrmzpb
  q_refrdom_nb = q_refrdom_nb + refrmzc*refrmznb
  r_mzrefrb = growmzc*refrmzcb
  q_pom_pb = pommzc*pommzpb
  q_pom_nb = pommzc*pommznb
  r_mzpomb = growmzc*pommzcb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) remimzpb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    r_mzremib = (y(imzp)-q_mz_p*y(imzc))*remimzpb
    yb(imzp) = yb(imzp) + r_mzremi*remimzpb
    yb(imzc) = yb(imzc) - r_mzremi*q_mz_p*remimzpb
  ELSE
    r_mzremib = (y(imzp)-q_mz_p*(y(imzn)/q_mz_n))*remimzpb
    yb(imzp) = yb(imzp) + r_mzremi*remimzpb
    yb(imzn) = yb(imzn) - r_mzremi*q_mz_p*remimzpb/q_mz_n
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) remimznb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    r_mzremib = r_mzremib + (y(imzn)-q_mz_n*y(imzc))*remimznb
    yb(imzn) = yb(imzn) + r_mzremi*remimznb
    yb(imzc) = yb(imzc) - r_mzremi*q_mz_n*remimznb
  ELSE
    r_mzremib = r_mzremib + (y(imzn)-q_mz_n*(y(imzp)/q_mz_p))*remimznb
    yb(imzn) = yb(imzn) + r_mzremi*remimznb
    yb(imzp) = yb(imzp) - r_mzremi*q_mz_n*remimznb/q_mz_p
  END IF
  temp97b1 = 0.5d0*excrmzsdom2pb/y(imzc)
  temp97b2 = 0.5d0*excrmzsdom2nb/y(imzc)
  excrmzsdom2cb = excrmzsdom2cb + y(imzn)*temp97b2 + y(imzp)*temp97b1
  yb(imzp) = yb(imzp) + excrmzsdom2c*temp97b1
  yb(imzc) = yb(imzc) - excrmzsdom2c*y(imzp)*temp97b1/y(imzc)
  yb(imzn) = yb(imzn) + excrmzsdom2c*temp97b2
  yb(imzc) = yb(imzc) + r_mzadju*temp*excrmzsdom2cb - excrmzsdom2c*y(&
&    imzn)*temp97b2/y(imzc)
  r_mzadjub = y(imzc)*temp*excrmzsdom2cb
  tempb = y(imzc)*r_mzadju*excrmzsdom2cb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    temp97b = -(tempb/(q_mz_n*y(imzc)))
    yb(imzn) = yb(imzn) + temp97b
    yb(imzc) = yb(imzc) - y(imzn)*temp97b/y(imzc)
  ELSE
    CALL POPREAL8(temp)
    temp97b0 = -(tempb/(q_mz_p*y(imzc)))
    yb(imzp) = yb(imzp) + temp97b0
    yb(imzc) = yb(imzc) - y(imzp)*temp97b0/y(imzc)
  END IF
  r_mzresp_1b = y(imzc)*respmzb
  yb(imzc) = yb(imzc) + r_mzresp_1*respmzb
  r_mzresp_2b = growmzc*respmzb
  growmzcb = growmzcb + f_exmzldom*r_mzex*excrmzldomcb + (c1-f_exmzldom)&
&    *r_mzex*excrmzsdomcb + r_mzresp_2*respmzb
  temp96 = q_mz_p*y(imzc)
  temp95 = r_mzex*growmzp/temp96
  temp95b = (c1-f_exmzldom)*y(imzp)*excrmzsdompb/temp96
  temp94 = q_mz_n*y(imzc)
  temp93 = r_mzex*growmzn/temp94
  f_exmzldomb = growmzc*r_mzex*excrmzldomcb + growmzn*r_mzex*&
&    excrmzldomnb + growmzp*r_mzex*excrmzldompb - r_mzex*growmzc*&
&    excrmzsdomcb - temp93*y(imzn)*excrmzsdomnb - temp95*y(imzp)*&
&    excrmzsdompb
  yb(imzp) = yb(imzp) + temp95*(c1-f_exmzldom)*excrmzsdompb
  temp93b = (c1-f_exmzldom)*y(imzn)*excrmzsdomnb/temp94
  r_mzexb = growmzc*f_exmzldom*excrmzldomcb + growmzn*f_exmzldom*&
&    excrmzldomnb + growmzp*f_exmzldom*excrmzldompb + (c1-f_exmzldom)*&
&    growmzc*excrmzsdomcb + growmzn*temp93b + growmzp*temp95b
  growmzpb = growmzpb + f_exmzldom*r_mzex*excrmzldompb + r_mzex*temp95b
  yb(imzc) = yb(imzc) - temp95*q_mz_p*temp95b
  yb(imzn) = yb(imzn) + temp93*(c1-f_exmzldom)*excrmzsdomnb
  growmznb = growmznb + f_exmzldom*r_mzex*excrmzldomnb + r_mzex*temp93b
  yb(imzc) = yb(imzc) - temp93*q_mz_n*temp93b
  temp93b0 = dydttb(iprtp)/secperday
  grazprtpb = growmzpb - temp93b0
  graztrpb = growmzpb
  dydttb(iprtp) = 0.D0
  temp93b1 = dydttb(iprtn)/secperday
  grazprtnb = growmznb - temp93b1
  graztrnb = growmznb
  dydttb(iprtn) = 0.D0
  temp93b2 = dydttb(iprtc)/secperday
  temp93b3 = grazprtpb/y(iprtc)
  temp93b4 = grazprtnb/y(iprtc)
  grazprtcb = y(iprtn)*temp93b4 + y(iprtp)*temp93b3 - temp93b2 + &
&    growmzcb
  graztrcb = growmzcb
  growprtpb = temp93b0
  excrprtldompb = excrprtldompb - temp93b0
  excrprtsdompb = excrprtsdompb - temp93b0
  excrprtsdom2pb = excrprtsdom2pb - temp93b0
  remiprtpb = remiprtpb - temp93b0
  pomprtpb = pomprtpb - temp93b0
  growprtnb = temp93b1
  excrprtldomnb = excrprtldomnb - temp93b1
  excrprtsdomnb = excrprtsdomnb - temp93b1
  excrprtsdom2nb = excrprtsdom2nb - temp93b1
  remiprtnb = remiprtnb - temp93b1
  pomprtnb = pomprtnb - temp93b1
  pomprtcb = pomprtcb + q_pom_n*pomprtnb + q_pom_p*pomprtpb - temp93b2
  growprtcb = r_pomprt*pomprtcb + temp93b2
  excrprtldomcb = excrprtldomcb - temp93b2
  excrprtsdomcb = excrprtsdomcb - temp93b2
  excrprtsdom2cb = excrprtsdom2cb - temp93b2
  respprtb = -temp93b2
  dydttb(iprtc) = 0.D0
  yb(iprtp) = yb(iprtp) + grazprtc*temp93b3
  yb(iprtc) = yb(iprtc) - grazprtc*y(iprtp)*temp93b3/y(iprtc)
  yb(iprtn) = yb(iprtn) + grazprtc*temp93b4
  yb(iprtc) = yb(iprtc) - grazprtc*y(iprtn)*temp93b4/y(iprtc)
  temp92 = g_tr**2
  temp89 = g_prt**2/temp92
  temp90 = y(iprtc)**2 + g_prt**2 + y(itrc)**2*temp89
  temp92b = grazprtcb/temp90
  temp91 = y(iprtc)**2
  temp90b = -(mu_mz*y(imzc)*temp91*temp92b/temp90)
  temp89b3 = y(itrc)**2*temp90b/temp92
  mu_mzb = temp91*y(imzc)*temp92b
  yb(imzc) = yb(imzc) + temp91*mu_mz*temp92b
  yb(iprtc) = yb(iprtc) + 2*y(iprtc)*temp90b + mu_mz*y(imzc)*2*y(iprtc)*&
&    temp92b
  g_prtb = 2*g_prt*temp89b3 + 2*g_prt*temp90b
  yb(itrc) = yb(itrc) + temp89*2*y(itrc)*temp90b
  g_trb = -(temp89*2*g_tr*temp89b3)
  q_pom_pb = q_pom_pb + pomprtc*pomprtpb
  q_pom_nb = q_pom_nb + pomprtc*pomprtnb
  r_pomprtb = growprtc*pomprtcb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) remiprtpb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    r_prtremib = (y(iprtp)-q_prt_p*y(iprtc))*remiprtpb
    yb(iprtp) = yb(iprtp) + r_prtremi*remiprtpb
    yb(iprtc) = yb(iprtc) - r_prtremi*q_prt_p*remiprtpb
  ELSE
    r_prtremib = (y(iprtp)-q_prt_p*(y(iprtn)/q_prt_n))*remiprtpb
    yb(iprtp) = yb(iprtp) + r_prtremi*remiprtpb
    yb(iprtn) = yb(iprtn) - r_prtremi*q_prt_p*remiprtpb/q_prt_n
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) remiprtnb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    r_prtremib = r_prtremib + (y(iprtn)-q_prt_n*y(iprtc))*remiprtnb
    yb(iprtn) = yb(iprtn) + r_prtremi*remiprtnb
    yb(iprtc) = yb(iprtc) - r_prtremi*q_prt_n*remiprtnb
  ELSE
    r_prtremib = r_prtremib + (y(iprtn)-q_prt_n*(y(iprtp)/q_prt_p))*&
&      remiprtnb
    yb(iprtn) = yb(iprtn) + r_prtremi*remiprtnb
    yb(iprtp) = yb(iprtp) - r_prtremi*q_prt_n*remiprtnb/q_prt_p
  END IF
  temp89b1 = 0.5d0*excrprtsdom2pb/y(iprtc)
  temp89b2 = 0.5d0*excrprtsdom2nb/y(iprtc)
  excrprtsdom2cb = excrprtsdom2cb + y(iprtn)*temp89b2 + y(iprtp)*&
&    temp89b1
  yb(iprtp) = yb(iprtp) + excrprtsdom2c*temp89b1
  yb(iprtc) = yb(iprtc) - excrprtsdom2c*y(iprtp)*temp89b1/y(iprtc)
  yb(iprtn) = yb(iprtn) + excrprtsdom2c*temp89b2
  yb(iprtc) = yb(iprtc) + r_prtadju*temp*excrprtsdom2cb - excrprtsdom2c*&
&    y(iprtn)*temp89b2/y(iprtc)
  r_prtadjub = y(iprtc)*temp*excrprtsdom2cb
  tempb = y(iprtc)*r_prtadju*excrprtsdom2cb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    temp89b = -(tempb/(q_prt_n*y(iprtc)))
    yb(iprtn) = yb(iprtn) + temp89b
    yb(iprtc) = yb(iprtc) - y(iprtn)*temp89b/y(iprtc)
  ELSE
    CALL POPREAL8(temp)
    temp89b0 = -(tempb/(q_prt_p*y(iprtc)))
    yb(iprtp) = yb(iprtp) + temp89b0
    yb(iprtc) = yb(iprtc) - y(iprtp)*temp89b0/y(iprtc)
  END IF
  r_prtresp_1b = y(iprtc)*respprtb
  yb(iprtc) = yb(iprtc) + r_prtresp_1*respprtb
  r_prtresp_2b = growprtc*respprtb
  growprtcb = growprtcb + f_exprtldom*r_prtex*excrprtldomcb + (c1-&
&    f_exprtldom)*r_prtex*excrprtsdomcb + r_prtresp_2*respprtb
  temp88 = q_prt_p*y(iprtc)
  temp87 = r_prtex*growprtp/temp88
  temp87b = (c1-f_exprtldom)*y(iprtp)*excrprtsdompb/temp88
  temp86 = q_prt_n*y(iprtc)
  temp85 = r_prtex*growprtn/temp86
  f_exprtldomb = growprtc*r_prtex*excrprtldomcb + growprtn*r_prtex*&
&    excrprtldomnb + growprtp*r_prtex*excrprtldompb - r_prtex*growprtc*&
&    excrprtsdomcb - temp85*y(iprtn)*excrprtsdomnb - temp87*y(iprtp)*&
&    excrprtsdompb
  yb(iprtp) = yb(iprtp) + temp87*(c1-f_exprtldom)*excrprtsdompb
  temp85b = (c1-f_exprtldom)*y(iprtn)*excrprtsdomnb/temp86
  r_prtexb = growprtc*f_exprtldom*excrprtldomcb + growprtn*f_exprtldom*&
&    excrprtldomnb + growprtp*f_exprtldom*excrprtldompb + (c1-&
&    f_exprtldom)*growprtc*excrprtsdomcb + growprtn*temp85b + growprtp*&
&    temp87b
  growprtpb = growprtpb + f_exprtldom*r_prtex*excrprtldompb + r_prtex*&
&    temp87b
  yb(iprtc) = yb(iprtc) - temp87*q_prt_p*temp87b
  yb(iprtn) = yb(iprtn) + temp85*(c1-f_exprtldom)*excrprtsdomnb
  growprtnb = growprtnb + f_exprtldom*r_prtex*excrprtldomnb + r_prtex*&
&    temp85b
  yb(iprtc) = yb(iprtc) - temp85*q_prt_n*temp85b
  grazsppb = growprtpb
  temp85b0 = dydttb(ibap)/secperday
  grazbapb = growprtpb - temp85b0
  grazunpb = growprtpb
  grazspnb = growprtnb
  dydttb(ibap) = 0.D0
  temp85b1 = dydttb(iban)/secperday
  grazbanb = growprtnb - temp85b1
  grazunnb = growprtnb
  grazspcb = growprtcb
  dydttb(iban) = 0.D0
  temp85b2 = dydttb(ibac)/secperday
  temp85b3 = grazbapb/y(ibac)
  temp85b4 = grazbanb/y(ibac)
  grazbacb = y(iban)*temp85b4 + y(ibap)*temp85b3 - temp85b2 + growprtcb
  grazuncb = growprtcb
  growbapo4b = fluxbapo4b
  remibapb = -temp85b0 - fluxbapo4b
  growbano3b = fluxbano3b
  growbanh4b = fluxbanh4b
  remibanb = -temp85b1 - fluxbanh4b
  growbapb = temp85b0
  refrbapb = -temp85b0
  excrbapb = excrbapb - temp85b0
  mortbapb = mortbapb - temp85b0
  growbanb = temp85b1
  refrbanb = -temp85b1
  excrbanb = excrbanb - temp85b1
  mortbanb = mortbanb - temp85b1
  growbacb = growbacb + temp85b2
  refrbacb = -temp85b2
  excrbacb = excrbacb - temp85b2
  respbab = respbab - temp85b2
  mortbacb = mortbacb - temp85b2
  dydttb(ibac) = 0.D0
  r_bamortb = y(ibac)*mortbacb + y(iban)*mortbanb + y(ibap)*mortbapb
  yb(ibap) = yb(ibap) + r_bamort*mortbapb
  yb(iban) = yb(iban) + r_bamort*mortbanb
  yb(ibac) = yb(ibac) + r_bamort*mortbacb
  yb(ibap) = yb(ibap) + grazbac*temp85b3
  yb(ibac) = yb(ibac) - grazbac*y(ibap)*temp85b3/y(ibac)
  yb(iban) = yb(iban) + grazbac*temp85b4
  yb(ibac) = yb(ibac) - grazbac*y(iban)*temp85b4/y(ibac)
  temp84 = g_un**2
  temp79 = g_ba**2/temp84
  temp83 = g_sp**2
  temp80 = g_ba**2/temp83
  temp81 = y(ibac)**2 + g_ba**2 + y(ispc)**2*temp80 + y(iunc)**2*temp79
  temp83b = grazbacb/temp81
  temp82 = y(ibac)**2
  temp81b = -(mu_prt*y(iprtc)*temp82*temp83b/temp81)
  temp80b = y(ispc)**2*temp81b/temp83
  temp79b0 = y(iunc)**2*temp81b/temp84
  mu_prtb = temp82*y(iprtc)*temp83b
  yb(iprtc) = yb(iprtc) + temp82*mu_prt*temp83b
  yb(ibac) = yb(ibac) + 2*y(ibac)*temp81b + mu_prt*y(iprtc)*2*y(ibac)*&
&    temp83b
  g_bab = 2*g_ba*temp79b0 + 2*g_ba*temp80b + 2*g_ba*temp81b
  yb(ispc) = yb(ispc) + temp80*2*y(ispc)*temp81b
  g_spb = -(temp80*2*g_sp*temp80b)
  yb(iunc) = yb(iunc) + temp79*2*y(iunc)*temp81b
  g_unb = -(temp79*2*g_un*temp79b0)
  CALL POPINTEGER4(branch)
  IF (branch .LT. 2) THEN
    IF (branch .LT. 1) THEN
      r_baadjub = (y(ibac)-y(iban)/q_ba_n)*excrbacb + (y(ibap)-q_ba_p*(y&
&        (iban)/q_ba_n))*excrbapb
      yb(ibap) = yb(ibap) + r_baadju*excrbapb
      yb(iban) = yb(iban) - r_baadju*q_ba_p*excrbapb/q_ba_n
      yb(ibac) = yb(ibac) + r_baadju*excrbacb
      yb(iban) = yb(iban) - r_baadju*excrbacb/q_ba_n
    ELSE
      r_baadjub = (y(ibac)-y(ibap)/q_ba_p)*excrbacb + (y(iban)-q_ba_n*(y&
&        (ibap)/q_ba_p))*excrbanb
      yb(iban) = yb(iban) + r_baadju*excrbanb
      yb(ibap) = yb(ibap) - r_baadju*q_ba_n*excrbanb/q_ba_p
      yb(ibac) = yb(ibac) + r_baadju*excrbacb
      yb(ibap) = yb(ibap) - r_baadju*excrbacb/q_ba_p
    END IF
    r_baremib = 0.D0
  ELSE
    r_baremib = (y(iban)-q_ba_n*y(ibac))*remibanb + (y(ibap)-q_ba_p*y(&
&      ibac))*remibapb
    yb(ibap) = yb(ibap) + r_baremi*remibapb
    yb(ibac) = yb(ibac) - r_baremi*q_ba_p*remibapb
    yb(iban) = yb(iban) + r_baremi*remibanb
    yb(ibac) = yb(ibac) - r_baremi*q_ba_n*remibanb
    r_baadjub = 0.D0
  END IF
  q_refrdom_pb = q_refrdom_pb + refrbac*refrbapb
  refrbacb = refrbacb + q_refrdom_n*refrbanb + q_refrdom_p*refrbapb
  q_refrdom_nb = q_refrdom_nb + refrbac*refrbanb
  r_barefrb = y(ibac)*refrbacb
  yb(ibac) = yb(ibac) + r_baresp_1*respbab + r_barefr*refrbacb
  temp79b = growbac*respbab
  temp78 = EXP(-(b_baresp*growbac))
  temp78b = (r_baresp_max-r_baresp_min)*EXP(-(b_baresp*growbac))*temp79b
  r_baresp_1b = y(ibac)*respbab
  zetab = growbano3*respbab
  growbano3b = growbano3b + growbanb + zeta*respbab
  r_baresp_minb = (1.D0-temp78)*temp79b
  r_baresp_maxb = temp78*temp79b
  b_barespb = -(growbac*temp78b)
  growbacb = growbacb + (r_baresp_min+(r_baresp_max-r_baresp_min)*temp78&
&    )*respbab - b_baresp*temp78b
  growbapo4b = growbapo4b + growbapb
  temp77 = y(ipo4)/y(ildomp)
  growbaldopb = growbaldopb + temp77*min14*growbapo4b + growbapb
  growbasdopb = growbasdopb + growbapb
  growbaldonb = growbaldonb + growbanb
  growbasdonb = growbasdonb + growbanb
  growbanh4b = growbanh4b + growbanb
  growbaldocb = growbaldocb + growbacb
  growbasdocb = growbasdocb + growbacb
  temp77b0 = growbaldop*min14*growbapo4b/y(ildomp)
  min14b = temp77*growbaldop*growbapo4b
  yb(ipo4) = yb(ipo4) + temp77b0
  yb(ildomp) = yb(ildomp) - temp77*temp77b0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    nfunc_ba_pb = 0.D0
  ELSE
    nfunc_ba_pb = -(min14b/nfunc_ba_p**2)
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 2) THEN
    IF (branch .LT. 1) THEN
      nfunc_ba_nb = 0.D0
      GOTO 100
    END IF
  ELSE
    growbano3b = 0.D0
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    temp77b = growbano3b/(y(ildomn)+y(isdomn))
    temp76 = y(ino3) + y(inh4)
    temp76b0 = -((growbaldon+growbasdon)*temp76*temp77b/(y(ildomn)+y(&
&      isdomn)))
    growbaldonb = growbaldonb + temp76*temp77b
    growbasdonb = growbasdonb + temp76*temp77b
    yb(ino3) = yb(ino3) + (growbaldon+growbasdon)*temp77b
    yb(inh4) = yb(inh4) + (growbaldon+growbasdon)*temp77b
    yb(ildomn) = yb(ildomn) + temp76b0
    yb(isdomn) = yb(isdomn) + temp76b0
    growbanh4b = growbanh4b - growbano3b
    x1b = 0.D0
  ELSE
    x1b = growbano3b
  END IF
  temp74 = y(ildomn) + y(isdomn)
  temp75 = y(ino3)/temp74
  temp76b = 0.1*temp75*x1b
  temp75b = 0.1*(growbaldon+growbasdon)*min15*x1b/temp74
  temp74b = -(temp75*temp75b)
  growbaldonb = growbaldonb + min15*temp76b
  growbasdonb = growbasdonb + min15*temp76b
  min15b = (growbaldon+growbasdon)*temp76b
  yb(ino3) = yb(ino3) + temp75b
  yb(ildomn) = yb(ildomn) + temp74b
  yb(isdomn) = yb(isdomn) + temp74b
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    nfunc_ba_nb = 0.D0
  ELSE
    nfunc_ba_nb = -(min15b/nfunc_ba_n**2)
  END IF
 100 temp73 = y(inh4)/y(ildomn)
  temp73b0 = growbaldon*min13*growbanh4b/y(ildomn)
  growbaldonb = growbaldonb + temp73*min13*growbanh4b
  min13b = temp73*growbaldon*growbanh4b
  yb(inh4) = yb(inh4) + temp73b0
  yb(ildomn) = yb(ildomn) - temp73*temp73b0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) nfunc_ba_nb = nfunc_ba_nb - min13b/nfunc_ba_n&
&      **2
  growbasdocb = growbasdocb + min12*growbasdopb
  min12b = growbasdoc*growbasdopb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    y4b = 0.D0
  ELSE
    y4b = min12b
  END IF
  temp73b = y4b/y(isdomc)
  temp72b0 = -(f_baslct*y4b/(nfunc_ba_p*y(isdomc)))
  temp72 = y(isdomp)/y(isdomc)
  temp72b1 = (q_ba_p-temp72)*y4b/nfunc_ba_p
  yb(isdomp) = yb(isdomp) + temp72b0 + temp73b
  yb(isdomc) = yb(isdomc) - temp72*temp72b0 - y(isdomp)*temp73b/y(isdomc&
&    )
  f_baslctb = temp72b1
  nfunc_ba_pb = nfunc_ba_pb - f_baslct*temp72b1/nfunc_ba_p
  growbasdocb = growbasdocb + min11*growbasdonb
  min11b = growbasdoc*growbasdonb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    y3b = 0.D0
  ELSE
    y3b = min11b
  END IF
  temp72b = y3b/y(isdomc)
  temp71b = -(f_baslct*y3b/(nfunc_ba_n*y(isdomc)))
  temp71 = y(isdomn)/y(isdomc)
  temp71b0 = (q_ba_n-temp71)*y3b/nfunc_ba_n
  yb(isdomn) = yb(isdomn) + temp71b + temp72b
  yb(isdomc) = yb(isdomc) - temp71*temp71b - y(isdomn)*temp72b/y(isdomc)
  f_baslctb = f_baslctb + temp71b0
  nfunc_ba_nb = nfunc_ba_nb - f_baslct*temp71b0/nfunc_ba_n
  temp71b1 = growbaldopb/y(ildomc)
  temp71b2 = growbaldonb/y(ildomc)
  growbaldocb = growbaldocb + y(ildomn)*temp71b2 + y(ildomp)*temp71b1
  yb(ildomp) = yb(ildomp) + growbaldoc*temp71b1
  yb(ildomc) = yb(ildomc) - growbaldoc*y(ildomp)*temp71b1/y(ildomc)
  yb(ildomn) = yb(ildomn) + growbaldoc*temp71b2
  yb(ildomc) = yb(ildomc) - growbaldoc*y(ildomn)*temp71b2/y(ildomc)
  temp69 = asc + k_dom + alc
  temp70 = mu_ba*temp/temp69
  temp70b = y(ibac)*asc*growbasdocb/temp69
  temp69b = -(temp70*temp70b)
  temp67 = alc + k_dom + asc
  temp68 = mu_ba*temp/temp67
  yb(ibac) = yb(ibac) + temp68*alc*growbaldocb + temp70*asc*growbasdocb
  temp68b = y(ibac)*alc*growbaldocb/temp67
  temp67b8 = -(temp68*temp68b)
  ascb = temp67b8 + temp69b + temp70*y(ibac)*growbasdocb
  mu_bab = temp*temp68b + temp*temp70b
  tempb = mu_ba*temp68b + mu_ba*temp70b
  k_domb = temp67b8 + temp69b
  alcb = temp68*y(ibac)*growbaldocb + temp67b8 + temp69b
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    nfunc_ba_nb = nfunc_ba_nb + tempb
  ELSE
    CALL POPREAL8(temp)
    nfunc_ba_pb = nfunc_ba_pb + tempb
  END IF
  temp67b = nfunc_ba_pb/(q_ba_p*y(ibac))
  yb(ibap) = yb(ibap) + temp67b
  yb(ibac) = yb(ibac) - y(ibap)*temp67b/y(ibac)
  temp67b0 = nfunc_ba_nb/(q_ba_n*y(ibac))
  yb(iban) = yb(iban) + temp67b0
  yb(ibac) = yb(ibac) - y(iban)*temp67b0/y(ibac)
  yb(isdomc) = yb(isdomc) + r_sdom*ascb
  r_sdomb = y(isdomc)*ascb
  yb(ildomc) = yb(ildomc) + alcb
  temp67b1 = dydttb(iunchl)/secperday
  growunchlb = temp67b1
  grazunchlb = -temp67b1
  pomunchlb = -temp67b1
  dydttb(iunchl) = 0.D0
  temp67b2 = dydttb(iunp)/secperday
  growunpb = growunpb + temp67b2
  excrun_1pb = excrun_1pb - temp67b2
  excrun_2pb = excrun_2pb - temp67b2
  grazunpb = grazunpb - temp67b2
  pomunpb = pomunpb - temp67b2
  dydttb(iunp) = 0.D0
  temp67b3 = dydttb(iunn)/secperday
  growunnb = temp67b3
  excrun_1nb = excrun_1nb - temp67b3
  excrun_2nb = excrun_2nb - temp67b3
  grazunnb = grazunnb - temp67b3
  pomunnb = pomunnb - temp67b3
  excrun_nh4b = excrun_nh4b - temp67b3
  dydttb(iunn) = 0.D0
  temp67b4 = dydttb(iunc)/secperday
  excrun_2cb = excrun_2cb - temp67b4
  growuncb = growuncb + 0.25*r_excrun_2*excrun_2cb + temp67b4
  excrun_1cb = excrun_1cb - temp67b4
  temp67b5 = grazunchlb/y(iunc)
  temp67b6 = grazunpb/y(iunc)
  temp67b7 = grazunnb/y(iunc)
  grazuncb = grazuncb + y(iunn)*temp67b7 + y(iunp)*temp67b6 + y(iunchl)*&
&    temp67b5 - temp67b4
  temp61b5 = pomunchlb/y(iunc)
  temp61b6 = pomunpb/y(iunc)
  temp61b7 = pomunnb/y(iunc)
  pomuncb = pomuncb + y(iunn)*temp61b7 + y(iunp)*temp61b6 + y(iunchl)*&
&    temp61b5 - temp67b4
  respunb = respunb - temp67b4
  dydttb(iunc) = 0.D0
  yb(iunchl) = yb(iunchl) + grazunc*temp67b5
  yb(iunc) = yb(iunc) - grazunc*y(iunchl)*temp67b5/y(iunc)
  yb(iunp) = yb(iunp) + grazunc*temp67b6
  yb(iunc) = yb(iunc) - grazunc*y(iunp)*temp67b6/y(iunc)
  yb(iunn) = yb(iunn) + grazunc*temp67b7
  yb(iunc) = yb(iunc) - grazunc*y(iunn)*temp67b7/y(iunc)
  temp66 = g_ba**2
  temp61 = g_un**2/temp66
  temp65 = g_sp**2
  temp62 = g_un**2/temp65
  temp63 = y(iunc)**2 + g_un**2 + y(ispc)**2*temp62 + y(ibac)**2*temp61
  temp65b = grazuncb/temp63
  temp64 = y(iunc)**2
  temp63b = -(mu_prt*y(iprtc)*temp64*temp65b/temp63)
  temp62b = y(ispc)**2*temp63b/temp65
  temp61b8 = y(ibac)**2*temp63b/temp66
  mu_prtb = mu_prtb + temp64*y(iprtc)*temp65b
  yb(iprtc) = yb(iprtc) + temp64*mu_prt*temp65b
  yb(iunc) = yb(iunc) + 2*y(iunc)*temp63b + mu_prt*y(iprtc)*2*y(iunc)*&
&    temp65b
  g_unb = g_unb + 2*g_un*temp61b8 + 2*g_un*temp62b + 2*g_un*temp63b
  yb(ispc) = yb(ispc) + temp62*2*y(ispc)*temp63b
  g_spb = g_spb - temp62*2*g_sp*temp62b
  yb(ibac) = yb(ibac) + temp61*2*y(ibac)*temp63b
  g_bab = g_bab - temp61*2*g_ba*temp61b8
  yb(iunchl) = yb(iunchl) + pomunc*temp61b5
  yb(iunc) = yb(iunc) - pomunc*y(iunchl)*temp61b5/y(iunc)
  yb(iunp) = yb(iunp) + pomunc*temp61b6
  yb(iunc) = yb(iunc) - pomunc*y(iunp)*temp61b6/y(iunc)
  yb(iunn) = yb(iunn) + pomunc*temp61b7
  yb(iunc) = yb(iunc) + r_pomun*2*y(iunc)*pomuncb - pomunc*y(iunn)*&
&    temp61b7/y(iunc)
  r_pomunb = y(iunc)**2*pomuncb
  r_excrun_2b = 0.25*growunc*excrun_2cb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    r_excrun_2b = r_excrun_2b + min10*excrun_2pb
    min10b = r_excrun_2*excrun_2pb
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      yb(iunp) = yb(iunp) + 0.25d0*temp1*min10b
      temp1b = 0.25d0*y(iunp)*min10b
    ELSE
      excrun_2cb = excrun_2cb + q_un_rdf_p*min10b
      temp1b = 0.D0
    END IF
    r_excrun_2b = r_excrun_2b + min9*excrun_2nb
    min9b = r_excrun_2*excrun_2nb
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      yb(iunn) = yb(iunn) + 0.25d0*temp*min9b
      tempb = 0.25d0*y(iunn)*min9b
    ELSE
      excrun_2cb = excrun_2cb + q_un_rdf_n*min9b
      tempb = 0.D0
    END IF
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      CALL POPREAL8(temp1)
    ELSE
      CALL POPREAL8(temp1)
      temp61b4 = -(q_un_rdf_p*temp1b/(q_un_rdf_n*y(iunp)))
      yb(iunn) = yb(iunn) + temp61b4
      yb(iunp) = yb(iunp) - y(iunn)*temp61b4/y(iunp)
    END IF
    CALL POPINTEGER4(branch)
    IF (.NOT.branch .LT. 1) THEN
      temp61b3 = -(q_un_rdf_n*tempb/(q_un_rdf_p*y(iunn)))
      yb(iunp) = yb(iunp) + temp61b3
      yb(iunn) = yb(iunn) - y(iunp)*temp61b3/y(iunn)
    END IF
  END IF
  yb(iunc) = yb(iunc) + r_excrun_2*max4*excrun_2cb
  r_excrun_2b = r_excrun_2b + y(iunc)*max4*excrun_2cb
  max4b = y(iunc)*r_excrun_2*excrun_2cb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    tempb = max4b
  ELSE
    tempb = 0.D0
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    temp61b1 = -(tempb/(q_un_rdf_n*y(iunc)))
    yb(iunn) = yb(iunn) + temp61b1
    yb(iunc) = yb(iunc) - y(iunn)*temp61b1/y(iunc)
  ELSE
    CALL POPREAL8(temp)
    temp61b2 = -(tempb/(q_un_rdf_p*y(iunc)))
    yb(iunp) = yb(iunp) + temp61b2
    yb(iunc) = yb(iunc) - y(iunp)*temp61b2/y(iunc)
  END IF
  temp61b0 = 0.5*min8*excrun_nh4b
  r_excrun_nb = growunnf*temp61b0
  growunnfb = r_excrun_n*temp61b0
  min8b = 0.5*r_excrun_n*growunnf*excrun_nh4b
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    nfunc_un_nb = 0.D0
  ELSE
    nfunc_un_nb = min8b
  END IF
  r_excrun_1b = y(iunn)*excrun_1nb + y(iunp)*excrun_1pb
  yb(iunp) = yb(iunp) + r_excrun_1*excrun_1pb
  temp61b = 0.5*min7*excrun_1nb
  yb(iunn) = yb(iunn) + r_excrun_1*excrun_1nb
  r_excrun_nb = r_excrun_nb + growunnf*temp61b
  growunnfb = growunnfb + r_excrun_n*temp61b
  min7b = 0.5*r_excrun_n*growunnf*excrun_1nb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) nfunc_un_nb = nfunc_un_nb + min7b
  r_excrun_1b = r_excrun_1b + y(iunc)*excrun_1cb
  yb(iunc) = yb(iunc) + r_excrun_1*excrun_1cb
  r_excrun_2b = r_excrun_2b + 0.75*growunc*excrun_1cb
  growuncb = growuncb + 0.75*r_excrun_2*excrun_1cb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    alpha_unb = 0.D0
    thetab = 0.D0
    a_unb = 0.D0
  ELSE
    temp60 = EXP(-(a_un*rlt))
    temp59 = y(iunchl)*alpha_un*rlt
    temp58 = temp59*temp60
    temp59b = growunchlb/temp58
    temp58b = -(theta*growunn*growunc*temp59b/temp58)
    temp58b0 = temp60*y(iunchl)*temp58b
    temp58b1 = temp59*EXP(-(a_un*rlt))*temp58b
    thetab = growunc*growunn*temp59b
    growunnb = growunnb + growunc*theta*temp59b
    growuncb = growuncb + theta*growunn*temp59b
    yb(iunchl) = yb(iunchl) + temp60*alpha_un*rlt*temp58b
    alpha_unb = rlt*temp58b0
    rltb = rltb + alpha_un*temp58b0 - a_un*temp58b1
    a_unb = -(rlt*temp58b1)
  END IF
  growunno3b = growunno3b + zeta*respunb
  zetab = zetab + growunno3*respunb
  growunnfb = growunnfb + zeta_nf*respunb
  zeta_nfb = growunnf*respunb
  temp56 = y(ipo4) + k_po4un
  temp57b = y(iunc)*y(ipo4)*growunpb/temp56
  temp57 = v_unp*v_unmax_p/temp56
  temp56b0 = -(temp57*temp57b)
  v_unpb = v_unmax_p*temp57b
  v_unmax_pb = v_unp*temp57b
  yb(ipo4) = yb(ipo4) + temp57*y(iunc)*growunpb + temp56b0
  k_po4unb = temp56b0
  yb(iunc) = yb(iunc) + temp57*y(ipo4)*growunpb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) v_unmax_pb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    temp56b = -(v_unmax_pb/((q_un_max_p-q_un_rdf_p)*y(iunc)))
    yb(iunp) = yb(iunp) + temp56b
    yb(iunc) = yb(iunc) - y(iunp)*temp56b/y(iunc)
  END IF
  growunnb = growunnb + growunnfb
  growunnh4b = growunnh4b - growunnfb
  growunno3b = growunno3b - growunnfb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    yb(iunc) = yb(iunc) + v_unn*v_unmax_n*growunnb
    v_unnb = y(iunc)*v_unmax_n*growunnb
    v_unmax_nb = y(iunc)*v_unn*growunnb
    maxunnfb = 0.D0
  ELSE
    growunnh4b = growunnh4b + growunnb
    growunno3b = growunno3b + growunnb
    maxunnfb = growunnb
    v_unmax_nb = 0.D0
    v_unnb = 0.D0
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    y2b = 0.D0
  ELSE
    y2b = maxunnfb
  END IF
  temp55 = c1 + q_un_max_n*zeta_nf
  temp54 = v_unmax_n*tfunc/temp55
  temp55b = temp54*y2b
  temp55b0 = q_un_max_n*temp55b
  temp54b = (q_un_max_n*(y(iunc)-growunc-growunno3*zeta)-y(iunn)-&
&    growunno3-growunnh4)*y2b/temp55
  yb(iunc) = yb(iunc) + temp55b0
  growuncb = growuncb - temp55b0
  growunno3b = growunno3b - temp55b - zeta*temp55b0
  zetab = zetab - growunno3*temp55b0
  yb(iunn) = yb(iunn) - temp55b
  growunnh4b = growunnh4b - temp55b
  temp51 = k_no3un/k_nh4un
  temp52 = y(ino3) + k_no3un + y(inh4)*temp51
  temp54b0 = growunno3b/temp52
  temp53 = y(iunc)*y(ino3)
  temp48 = k_nh4un/k_no3un
  temp49 = y(inh4) + k_nh4un + y(ino3)*temp48
  temp51b = growunnh4b/temp49
  temp50 = y(iunc)*y(inh4)
  v_unmax_nb = v_unmax_nb + temp50*v_unn*temp51b + temp53*v_unn*temp54b0&
&   + tfunc*temp54b
  tfuncb = v_unmax_n*temp54b
  zeta_nfb = zeta_nfb - temp54*q_un_max_n*temp54b
  temp53b = v_unn*v_unmax_n*temp54b0
  temp52b = -(v_unn*v_unmax_n*temp53*temp54b0/temp52)
  temp51b0 = y(inh4)*temp52b/k_nh4un
  v_unnb = v_unnb + temp50*v_unmax_n*temp51b + temp53*v_unmax_n*temp54b0
  yb(iunc) = yb(iunc) + y(ino3)*temp53b
  yb(ino3) = yb(ino3) + temp52b + y(iunc)*temp53b
  temp49b = -(v_unn*v_unmax_n*temp50*temp51b/temp49)
  temp48b0 = y(ino3)*temp49b/k_no3un
  k_no3unb = temp51b0 - temp48*temp48b0 + temp52b
  yb(inh4) = yb(inh4) + temp51*temp52b
  k_nh4unb = temp49b + temp48b0 - temp51*temp51b0
  temp50b = v_unn*v_unmax_n*temp51b
  yb(iunc) = yb(iunc) + y(inh4)*temp50b
  yb(inh4) = yb(inh4) + temp49b + y(iunc)*temp50b
  yb(ino3) = yb(ino3) + temp48*temp49b
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) v_unmax_nb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    temp48b = -(v_unmax_nb/((q_un_max_n-q_un_rdf_n)*y(iunc)))
    yb(iunn) = yb(iunn) + temp48b
    yb(iunc) = yb(iunc) - y(iunn)*temp48b/y(iunc)
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    pc_unmaxb = 0.D0
  ELSE
    temp47 = EXP(-(a_un*rlt))
    temp44 = y(iunc)*pc_unmax
    temp46 = y(iunchl)*alpha_un*rlt
    temp45 = temp46/temp44
    temp45b = y(iunc)*pc_unmax*temp47*EXP(-temp45)*growuncb/temp44
    temp44b8 = -(temp45*temp45b)
    temp44b9 = (c1-EXP(-temp45))*growuncb
    temp44b10 = y(iunc)*pc_unmax*EXP(-(a_un*rlt))*temp44b9
    yb(iunchl) = yb(iunchl) + alpha_un*rlt*temp45b
    alpha_unb = alpha_unb + y(iunchl)*rlt*temp45b
    rltb = rltb + y(iunchl)*alpha_un*temp45b - a_un*temp44b10
    yb(iunc) = yb(iunc) + temp47*pc_unmax*temp44b9 + pc_unmax*temp44b8
    pc_unmaxb = temp47*y(iunc)*temp44b9 + y(iunc)*temp44b8
    a_unb = a_unb - rlt*temp44b10
  END IF
  mu_unb = temp*pc_unmaxb
  tempb = mu_un*pc_unmaxb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    nfunc_un_nb = nfunc_un_nb + tempb
    nfunc_un_pb = 0.D0
  ELSE
    CALL POPREAL8(temp)
    nfunc_un_pb = tempb
  END IF
  temp44b = nfunc_un_pb/((q_un_rdf_p-q_un_min_p)*y(iunc))
  yb(iunp) = yb(iunp) + temp44b
  yb(iunc) = yb(iunc) - y(iunp)*temp44b/y(iunc)
  temp44b0 = nfunc_un_nb/((q_un_rdf_n-q_un_min_n)*y(iunc))
  yb(iunn) = yb(iunn) + temp44b0
  yb(iunc) = yb(iunc) - y(iunn)*temp44b0/y(iunc)
  temp44b1 = dydttb(itrchl)/secperday
  growtrchlb = temp44b1
  graztrchlb = -temp44b1
  pomtrchlb = -temp44b1
  dydttb(itrchl) = 0.D0
  temp44b2 = dydttb(itrp)/secperday
  growtrpb = temp44b2
  excrtr_1pb = excrtr_1pb - temp44b2
  excrtr_2pb = excrtr_2pb - temp44b2
  graztrpb = graztrpb - temp44b2
  pomtrpb = pomtrpb - temp44b2
  dydttb(itrp) = 0.D0
  temp44b3 = dydttb(itrn)/secperday
  growtrnb = temp44b3
  excrtr_1nb = excrtr_1nb - temp44b3
  excrtr_2nb = excrtr_2nb - temp44b3
  graztrnb = graztrnb - temp44b3
  pomtrnb = pomtrnb - temp44b3
  excrtr_nh4b = excrtr_nh4b - temp44b3
  dydttb(itrn) = 0.D0
  temp44b4 = dydttb(itrc)/secperday
  excrtr_2cb = excrtr_2cb - temp44b4
  growtrcb = growtrcb + 0.25*r_excrtr_2*excrtr_2cb + temp44b4
  excrtr_1cb = excrtr_1cb - temp44b4
  temp44b5 = graztrchlb/y(itrc)
  temp44b6 = graztrpb/y(itrc)
  temp44b7 = graztrnb/y(itrc)
  graztrcb = graztrcb + y(itrn)*temp44b7 + y(itrp)*temp44b6 + y(itrchl)*&
&    temp44b5 - temp44b4
  temp40b5 = pomtrchlb/y(itrc)
  temp40b6 = pomtrpb/y(itrc)
  temp40b7 = pomtrnb/y(itrc)
  pomtrcb = pomtrcb + y(itrn)*temp40b7 + y(itrp)*temp40b6 + y(itrchl)*&
&    temp40b5 - temp44b4
  resptrb = resptrb - temp44b4
  dydttb(itrc) = 0.D0
  yb(itrchl) = yb(itrchl) + graztrc*temp44b5
  yb(itrc) = yb(itrc) - graztrc*y(itrchl)*temp44b5/y(itrc)
  yb(itrp) = yb(itrp) + graztrc*temp44b6
  yb(itrc) = yb(itrc) - graztrc*y(itrp)*temp44b6/y(itrc)
  yb(itrn) = yb(itrn) + graztrc*temp44b7
  yb(itrc) = yb(itrc) - graztrc*y(itrn)*temp44b7/y(itrc)
  temp43 = g_prt**2
  temp40 = g_tr**2/temp43
  temp41 = y(itrc)**2 + g_tr**2 + y(iprtc)**2*temp40
  temp43b = graztrcb/temp41
  temp42 = y(itrc)**2
  temp41b = -(mu_mz*y(imzc)*temp42*temp43b/temp41)
  temp40b8 = y(iprtc)**2*temp41b/temp43
  mu_mzb = mu_mzb + temp42*y(imzc)*temp43b
  yb(imzc) = yb(imzc) + temp42*mu_mz*temp43b
  yb(itrc) = yb(itrc) + 2*y(itrc)*temp41b + mu_mz*y(imzc)*2*y(itrc)*&
&    temp43b
  g_trb = g_trb + 2*g_tr*temp40b8 + 2*g_tr*temp41b
  yb(iprtc) = yb(iprtc) + temp40*2*y(iprtc)*temp41b
  g_prtb = g_prtb - temp40*2*g_prt*temp40b8
  yb(itrchl) = yb(itrchl) + pomtrc*temp40b5
  yb(itrc) = yb(itrc) - pomtrc*y(itrchl)*temp40b5/y(itrc)
  yb(itrp) = yb(itrp) + pomtrc*temp40b6
  yb(itrc) = yb(itrc) - pomtrc*y(itrp)*temp40b6/y(itrc)
  yb(itrn) = yb(itrn) + pomtrc*temp40b7
  yb(itrc) = yb(itrc) + r_pomtr*2*y(itrc)*pomtrcb - pomtrc*y(itrn)*&
&    temp40b7/y(itrc)
  r_pomtrb = y(itrc)**2*pomtrcb
  r_excrtr_2b = 0.25*growtrc*excrtr_2cb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    r_excrtr_2b = r_excrtr_2b + min6*excrtr_2pb
    min6b = r_excrtr_2*excrtr_2pb
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      yb(itrp) = yb(itrp) + 0.25d0*temp1*min6b
      temp1b = 0.25d0*y(itrp)*min6b
    ELSE
      excrtr_2cb = excrtr_2cb + q_tr_rdf_p*min6b
      temp1b = 0.D0
    END IF
    r_excrtr_2b = r_excrtr_2b + min5*excrtr_2nb
    min5b = r_excrtr_2*excrtr_2nb
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      yb(itrn) = yb(itrn) + 0.25d0*temp*min5b
      tempb = 0.25d0*y(itrn)*min5b
    ELSE
      excrtr_2cb = excrtr_2cb + q_tr_rdf_n*min5b
      tempb = 0.D0
    END IF
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      CALL POPREAL8(temp1)
    ELSE
      CALL POPREAL8(temp1)
      temp40b4 = -(q_tr_rdf_p*temp1b/(q_tr_rdf_n*y(itrp)))
      yb(itrn) = yb(itrn) + temp40b4
      yb(itrp) = yb(itrp) - y(itrn)*temp40b4/y(itrp)
    END IF
    CALL POPINTEGER4(branch)
    IF (.NOT.branch .LT. 1) THEN
      temp40b3 = -(q_tr_rdf_n*tempb/(q_tr_rdf_p*y(itrn)))
      yb(itrp) = yb(itrp) + temp40b3
      yb(itrn) = yb(itrn) - y(itrp)*temp40b3/y(itrn)
    END IF
  END IF
  yb(itrc) = yb(itrc) + r_excrtr_2*max3*excrtr_2cb
  r_excrtr_2b = r_excrtr_2b + y(itrc)*max3*excrtr_2cb
  max3b = y(itrc)*r_excrtr_2*excrtr_2cb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    tempb = max3b
  ELSE
    tempb = 0.D0
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    temp40b1 = -(tempb/(q_tr_rdf_n*y(itrc)))
    yb(itrn) = yb(itrn) + temp40b1
    yb(itrc) = yb(itrc) - y(itrn)*temp40b1/y(itrc)
  ELSE
    CALL POPREAL8(temp)
    temp40b2 = -(tempb/(q_tr_rdf_p*y(itrc)))
    yb(itrp) = yb(itrp) + temp40b2
    yb(itrc) = yb(itrc) - y(itrp)*temp40b2/y(itrc)
  END IF
  temp40b0 = 0.5*min4*excrtr_nh4b
  r_excrtr_nb = growtrnf*temp40b0
  growtrnfb = r_excrtr_n*temp40b0
  min4b = 0.5*r_excrtr_n*growtrnf*excrtr_nh4b
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    nfunc_tr_nb = 0.D0
  ELSE
    nfunc_tr_nb = min4b
  END IF
  r_excrtr_1b = y(itrn)*excrtr_1nb + y(itrp)*excrtr_1pb
  yb(itrp) = yb(itrp) + r_excrtr_1*excrtr_1pb
  temp40b = 0.5*min3*excrtr_1nb
  yb(itrn) = yb(itrn) + r_excrtr_1*excrtr_1nb
  r_excrtr_nb = r_excrtr_nb + growtrnf*temp40b
  growtrnfb = growtrnfb + r_excrtr_n*temp40b
  min3b = 0.5*r_excrtr_n*growtrnf*excrtr_1nb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) nfunc_tr_nb = nfunc_tr_nb + min3b
  r_excrtr_1b = r_excrtr_1b + y(itrc)*excrtr_1cb
  yb(itrc) = yb(itrc) + r_excrtr_1*excrtr_1cb
  r_excrtr_2b = r_excrtr_2b + 0.75*growtrc*excrtr_1cb
  growtrcb = growtrcb + 0.75*r_excrtr_2*excrtr_1cb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    alpha_trb = 0.D0
    a_trb = 0.D0
  ELSE
    temp39 = EXP(-(a_tr*rlt))
    temp38 = y(itrchl)*alpha_tr*rlt
    temp37 = temp38*temp39
    temp38b = growtrchlb/temp37
    temp37b = -(theta*growtrn*growtrc*temp38b/temp37)
    temp37b0 = temp39*y(itrchl)*temp37b
    temp37b1 = temp38*EXP(-(a_tr*rlt))*temp37b
    thetab = thetab + growtrc*growtrn*temp38b
    growtrnb = growtrnb + growtrc*theta*temp38b
    growtrcb = growtrcb + theta*growtrn*temp38b
    yb(itrchl) = yb(itrchl) + temp39*alpha_tr*rlt*temp37b
    alpha_trb = rlt*temp37b0
    rltb = rltb + alpha_tr*temp37b0 - a_tr*temp37b1
    a_trb = -(rlt*temp37b1)
  END IF
  growtrno3b = growtrno3b + zeta*resptrb
  zetab = zetab + growtrno3*resptrb
  growtrnfb = growtrnfb + zeta_nf*resptrb
  zeta_nfb = zeta_nfb + growtrnf*resptrb
  growtrpo4b = growtrpo4b + growtrpb
  picktrpo4b = growtrpb
  mu_picktrpo4b = max2*picktrpo4b
  max2b = mu_picktrpo4*picktrpo4b
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    yb(itrc) = yb(itrc) + (q_tr_max_p+q_tr_rdf_p)*max2b/2
    yb(itrp) = yb(itrp) - max2b
  END IF
  temp35 = y(ipo4) + k_po4tr
  temp36b = y(itrc)*y(ipo4)*growtrpo4b/temp35
  temp36 = v_trp*v_trmax_p/temp35
  temp35b0 = -(temp36*temp36b)
  v_trpb = v_trmax_p*temp36b
  v_trmax_pb = v_trp*temp36b
  yb(ipo4) = yb(ipo4) + temp36*y(itrc)*growtrpo4b + temp35b0
  k_po4trb = temp35b0
  yb(itrc) = yb(itrc) + temp36*y(ipo4)*growtrpo4b
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) v_trmax_pb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    temp35b = -(v_trmax_pb/((q_tr_max_p-q_tr_rdf_p)*y(itrc)))
    yb(itrp) = yb(itrp) + temp35b
    yb(itrc) = yb(itrc) - y(itrp)*temp35b/y(itrc)
  END IF
  growtrnb = growtrnb + growtrnfb
  growtrnh4b = growtrnh4b - growtrnfb
  growtrno3b = growtrno3b - growtrnfb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    yb(itrc) = yb(itrc) + v_trn*v_trmax_n*growtrnb
    v_trnb = y(itrc)*v_trmax_n*growtrnb
    v_trmax_nb = y(itrc)*v_trn*growtrnb
    maxtrnfb = 0.D0
  ELSE
    growtrnh4b = growtrnh4b + growtrnb
    growtrno3b = growtrno3b + growtrnb
    maxtrnfb = growtrnb
    v_trnb = 0.D0
    v_trmax_nb = 0.D0
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 2) THEN
    IF (branch .LT. 1) THEN
      GOTO 110
    ELSE
      y1b = 0.D0
    END IF
  ELSE
    y1b = maxtrnfb
  END IF
  temp34 = c1 + q_tr_max_n*zeta_nf
  temp33 = v_trmax_n*tfunc/temp34
  temp34b = temp33*y1b
  temp34b0 = q_tr_max_n*temp34b
  temp33b0 = (q_tr_max_n*(y(itrc)+growtrc-growtrno3*zeta)-y(itrn)-&
&    growtrno3-growtrnh4)*y1b/temp34
  yb(itrc) = yb(itrc) + temp34b0
  growtrcb = growtrcb + temp34b0
  growtrno3b = growtrno3b - temp34b - zeta*temp34b0
  zetab = zetab - growtrno3*temp34b0
  yb(itrn) = yb(itrn) - temp34b
  growtrnh4b = growtrnh4b - temp34b
  v_trmax_nb = v_trmax_nb + tfunc*temp33b0
  tfuncb = tfuncb + v_trmax_n*temp33b0
  zeta_nfb = zeta_nfb - temp33*q_tr_max_n*temp33b0
 110 temp30 = k_no3tr/k_nh4tr
  temp31 = y(ino3) + k_no3tr + y(inh4)*temp30
  temp33b = growtrno3b/temp31
  temp32 = y(itrc)*y(ino3)
  temp32b = v_trn*v_trmax_n*temp33b
  temp31b = -(v_trn*v_trmax_n*temp32*temp33b/temp31)
  temp30b = y(inh4)*temp31b/k_nh4tr
  temp27 = k_nh4tr/k_no3tr
  temp28 = y(inh4) + k_nh4tr + y(ino3)*temp27
  temp30b0 = growtrnh4b/temp28
  temp29 = y(itrc)*y(inh4)
  v_trnb = v_trnb + temp29*v_trmax_n*temp30b0 + temp32*v_trmax_n*temp33b
  v_trmax_nb = v_trmax_nb + temp29*v_trn*temp30b0 + temp32*v_trn*temp33b
  yb(itrc) = yb(itrc) + y(ino3)*temp32b
  yb(ino3) = yb(ino3) + temp31b + y(itrc)*temp32b
  temp28b = -(v_trn*v_trmax_n*temp29*temp30b0/temp28)
  temp27b0 = y(ino3)*temp28b/k_no3tr
  k_no3trb = temp30b - temp27*temp27b0 + temp31b
  yb(inh4) = yb(inh4) + temp30*temp31b
  k_nh4trb = temp28b + temp27b0 - temp30*temp30b
  temp29b = v_trn*v_trmax_n*temp30b0
  yb(itrc) = yb(itrc) + y(inh4)*temp29b
  yb(inh4) = yb(inh4) + temp28b + y(itrc)*temp29b
  yb(ino3) = yb(ino3) + temp27*temp28b
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) v_trmax_nb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    temp27b = -(v_trmax_nb/((q_tr_max_n-q_tr_rdf_n)*y(itrc)))
    yb(itrn) = yb(itrn) + temp27b
    yb(itrc) = yb(itrc) - y(itrn)*temp27b/y(itrc)
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    pc_trmaxb = 0.D0
  ELSE
    temp26 = EXP(-(a_tr*rlt))
    temp23 = y(itrc)*pc_trmax
    temp25 = y(itrchl)*alpha_tr*rlt
    temp24 = temp25/temp23
    temp24b = y(itrc)*pc_trmax*temp26*EXP(-temp24)*growtrcb/temp23
    temp23b8 = -(temp24*temp24b)
    temp23b9 = (c1-EXP(-temp24))*growtrcb
    temp23b10 = y(itrc)*pc_trmax*EXP(-(a_tr*rlt))*temp23b9
    yb(itrchl) = yb(itrchl) + alpha_tr*rlt*temp24b
    alpha_trb = alpha_trb + y(itrchl)*rlt*temp24b
    rltb = rltb + y(itrchl)*alpha_tr*temp24b - a_tr*temp23b10
    yb(itrc) = yb(itrc) + temp26*pc_trmax*temp23b9 + pc_trmax*temp23b8
    pc_trmaxb = temp26*y(itrc)*temp23b9 + y(itrc)*temp23b8
    a_trb = a_trb - rlt*temp23b10
  END IF
  mu_trb = temp*pc_trmaxb
  tempb = mu_tr*pc_trmaxb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    nfunc_tr_nb = nfunc_tr_nb + tempb
    nfunc_tr_pb = 0.D0
  ELSE
    CALL POPREAL8(temp)
    nfunc_tr_pb = tempb
  END IF
  temp23b = nfunc_tr_pb/((q_tr_rdf_p-q_tr_min_p)*y(itrc))
  yb(itrp) = yb(itrp) + temp23b
  yb(itrc) = yb(itrc) - y(itrp)*temp23b/y(itrc)
  temp23b0 = nfunc_tr_nb/((q_tr_rdf_n-q_tr_min_n)*y(itrc))
  yb(itrn) = yb(itrn) + temp23b0
  yb(itrc) = yb(itrc) - y(itrn)*temp23b0/y(itrc)
  temp23b1 = dydttb(ispchl)/secperday
  growspchlb = temp23b1
  grazspchlb = -temp23b1
  pomspchlb = -temp23b1
  dydttb(ispchl) = 0.D0
  temp23b2 = dydttb(ispp)/secperday
  growsppb = growsppb + temp23b2
  excrsp_1pb = excrsp_1pb - temp23b2
  excrsp_2pb = excrsp_2pb - temp23b2
  grazsppb = grazsppb - temp23b2
  pomsppb = pomsppb - temp23b2
  dydttb(ispp) = 0.D0
  temp23b3 = dydttb(ispn)/secperday
  growspnb = temp23b3
  excrsp_1nb = excrsp_1nb - temp23b3
  excrsp_2nb = excrsp_2nb - temp23b3
  temp23b4 = grazspchlb/y(ispn)
  grazspnb = grazspnb + y(ispchl)*temp23b4 - temp23b3
  temp17b3 = pomspchlb/y(ispn)
  pomspnb = pomspnb + y(ispchl)*temp17b3 - temp23b3
  dydttb(ispn) = 0.D0
  temp23b5 = dydttb(ispc)/secperday
  excrsp_2cb = excrsp_2cb - temp23b5
  growspcb = growspcb + 0.25*r_excrsp_2*excrsp_2cb + temp23b5
  excrsp_1cb = excrsp_1cb - temp23b5
  temp23b6 = grazsppb/y(ispc)
  temp23b7 = grazspnb/y(ispc)
  grazspcb = grazspcb + y(ispn)*temp23b7 + y(ispp)*temp23b6 - temp23b5
  temp17b4 = pomsppb/y(ispc)
  temp17b5 = pomspnb/y(ispc)
  pomspcb = pomspcb + y(ispn)*temp17b5 + y(ispp)*temp17b4 - temp23b5
  respspb = respspb - temp23b5
  dydttb(ispc) = 0.D0
  yb(ispchl) = yb(ispchl) + grazspn*temp23b4
  yb(ispn) = yb(ispn) - grazspn*y(ispchl)*temp23b4/y(ispn)
  yb(ispp) = yb(ispp) + grazspc*temp23b6
  yb(ispc) = yb(ispc) - grazspc*y(ispp)*temp23b6/y(ispc)
  yb(ispn) = yb(ispn) + grazspc*temp23b7
  yb(ispc) = yb(ispc) - grazspc*y(ispn)*temp23b7/y(ispc)
  temp22 = g_ba**2
  temp17 = g_sp**2/temp22
  temp21 = g_un**2
  temp18 = g_sp**2/temp21
  temp19 = y(ispc)**2 + g_sp**2 + y(iunc)**2*temp18 + y(ibac)**2*temp17
  temp21b = grazspcb/temp19
  temp20 = y(ispc)**2
  temp19b = -(mu_prt*y(iprtc)*temp20*temp21b/temp19)
  temp18b = y(iunc)**2*temp19b/temp21
  temp17b6 = y(ibac)**2*temp19b/temp22
  mu_prtb = mu_prtb + temp20*y(iprtc)*temp21b
  yb(iprtc) = yb(iprtc) + temp20*mu_prt*temp21b
  yb(ispc) = yb(ispc) + 2*y(ispc)*temp19b + mu_prt*y(iprtc)*2*y(ispc)*&
&    temp21b
  g_spb = g_spb + 2*g_sp*temp17b6 + 2*g_sp*temp18b + 2*g_sp*temp19b
  yb(iunc) = yb(iunc) + temp18*2*y(iunc)*temp19b
  g_unb = g_unb - temp18*2*g_un*temp18b
  yb(ibac) = yb(ibac) + temp17*2*y(ibac)*temp19b
  g_bab = g_bab - temp17*2*g_ba*temp17b6
  yb(ispchl) = yb(ispchl) + pomspn*temp17b3
  yb(ispn) = yb(ispn) - pomspn*y(ispchl)*temp17b3/y(ispn)
  yb(ispp) = yb(ispp) + pomspc*temp17b4
  yb(ispc) = yb(ispc) - pomspc*y(ispp)*temp17b4/y(ispc)
  yb(ispn) = yb(ispn) + pomspc*temp17b5
  yb(ispc) = yb(ispc) + r_pomsp*2*y(ispc)*pomspcb - pomspc*y(ispn)*&
&    temp17b5/y(ispc)
  r_pomspb = y(ispc)**2*pomspcb
  r_excrsp_2b = 0.25*growspc*excrsp_2cb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    min2b = 0.5*excrsp_2pb
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      yb(ispp) = yb(ispp) + 0.25d0*temp1*min2b
      temp1b = 0.25d0*y(ispp)*min2b
    ELSE
      excrsp_2cb = excrsp_2cb + q_sp_rdf_p*min2b
      temp1b = 0.D0
    END IF
    min1b = 0.5*excrsp_2nb
    CALL POPINTEGER4(branch)
    IF (branch .LT. 1) THEN
      yb(ispn) = yb(ispn) + 0.25d0*temp*min1b
      tempb = 0.25d0*y(ispn)*min1b
    ELSE
      excrsp_2cb = excrsp_2cb + q_sp_rdf_n*min1b
      tempb = 0.D0
    END IF
    CALL POPINTEGER4(branch)
    IF (.NOT.branch .LT. 1) THEN
      temp17b2 = -(q_sp_rdf_p*temp1b/(q_sp_rdf_n*y(ispp)))
      yb(ispn) = yb(ispn) + temp17b2
      yb(ispp) = yb(ispp) - y(ispn)*temp17b2/y(ispp)
    END IF
    CALL POPINTEGER4(branch)
    IF (.NOT.branch .LT. 1) THEN
      temp17b1 = -(q_sp_rdf_n*tempb/(q_sp_rdf_p*y(ispn)))
      yb(ispp) = yb(ispp) + temp17b1
      yb(ispn) = yb(ispn) - y(ispp)*temp17b1/y(ispn)
    END IF
  END IF
  yb(ispc) = yb(ispc) + 0.5*max1*excrsp_2cb
  max1b = 0.5*y(ispc)*excrsp_2cb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    tempb = max1b
  ELSE
    tempb = 0.D0
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    CALL POPREAL8(temp)
    temp17b = -(tempb/(q_sp_rdf_n*y(ispc)))
    yb(ispn) = yb(ispn) + temp17b
    yb(ispc) = yb(ispc) - y(ispn)*temp17b/y(ispc)
  ELSE
    CALL POPREAL8(temp)
    temp17b0 = -(tempb/(q_sp_rdf_p*y(ispc)))
    yb(ispp) = yb(ispp) + temp17b0
    yb(ispc) = yb(ispc) - y(ispp)*temp17b0/y(ispc)
  END IF
  r_excrsp_1b = y(ispc)*excrsp_1cb + y(ispn)*excrsp_1nb + y(ispp)*&
&    excrsp_1pb
  yb(ispp) = yb(ispp) + r_excrsp_1*excrsp_1pb
  yb(ispn) = yb(ispn) + r_excrsp_1*excrsp_1nb
  yb(ispc) = yb(ispc) + r_excrsp_1*excrsp_1cb
  r_excrsp_2b = r_excrsp_2b + 0.75*growspc*excrsp_1cb
  growspcb = growspcb + 0.75*r_excrsp_2*excrsp_1cb
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    alpha_spb = 0.D0
    a_spb = 0.D0
  ELSE
    temp16 = EXP(-(a_sp*rlt))
    temp15 = y(ispchl)*alpha_sp*rlt
    temp14 = temp15*temp16
    temp15b = growspchlb/temp14
    temp14b = -(theta*growspn*growspc*temp15b/temp14)
    temp14b0 = temp16*y(ispchl)*temp14b
    temp14b1 = temp15*EXP(-(a_sp*rlt))*temp14b
    thetab = thetab + growspc*growspn*temp15b
    growspnb = growspnb + growspc*theta*temp15b
    growspcb = growspcb + theta*growspn*temp15b
    yb(ispchl) = yb(ispchl) + temp16*alpha_sp*rlt*temp14b
    alpha_spb = rlt*temp14b0
    rltb = rltb + alpha_sp*temp14b0 - a_sp*temp14b1
    a_spb = -(rlt*temp14b1)
  END IF
  growspno3b = growspno3b + zeta*respspb
  zetab = zetab + growspno3*respspb
  temp12 = y(ipo4) + k_po4sp
  temp13b = y(ispc)*y(ipo4)*growsppb/temp12
  temp13 = v_spp*v_spmax_p/temp12
  temp12b1 = -(temp13*temp13b)
  v_sppb = v_spmax_p*temp13b
  v_spmax_pb = v_spp*temp13b
  yb(ipo4) = yb(ipo4) + temp13*y(ispc)*growsppb + temp12b1
  k_po4spb = temp12b1
  yb(ispc) = yb(ispc) + temp13*y(ipo4)*growsppb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) v_spmax_pb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    temp12b0 = -(v_spmax_pb/((q_sp_max_p-q_sp_rdf_p)*y(ispc)))
    yb(ispp) = yb(ispp) + temp12b0
    yb(ispc) = yb(ispc) - y(ispp)*temp12b0/y(ispc)
  END IF
  growspnh4b = growspnh4b + growspnb
  growspno3b = growspno3b + growspnb
  temp9 = k_no3sp/k_nh4sp
  temp10 = y(ino3) + k_no3sp + y(inh4)*temp9
  temp12b = growspno3b/temp10
  temp11 = y(ispc)*y(ino3)
  temp11b = v_spn*v_spmax_n*temp12b
  temp10b = -(v_spn*v_spmax_n*temp11*temp12b/temp10)
  temp9b = y(inh4)*temp10b/k_nh4sp
  temp6 = k_nh4sp/k_no3sp
  temp7 = y(inh4) + k_nh4sp + y(ino3)*temp6
  temp9b0 = growspnh4b/temp7
  temp8 = y(ispc)*y(inh4)
  v_spnb = temp8*v_spmax_n*temp9b0 + temp11*v_spmax_n*temp12b
  v_spmax_nb = temp8*v_spn*temp9b0 + temp11*v_spn*temp12b
  yb(ispc) = yb(ispc) + y(ino3)*temp11b
  yb(ino3) = yb(ino3) + temp10b + y(ispc)*temp11b
  temp7b = -(v_spn*v_spmax_n*temp8*temp9b0/temp7)
  temp6b0 = y(ino3)*temp7b/k_no3sp
  k_no3spb = temp9b - temp6*temp6b0 + temp10b
  yb(inh4) = yb(inh4) + temp9*temp10b
  k_nh4spb = temp7b + temp6b0 - temp9*temp9b
  temp8b = v_spn*v_spmax_n*temp9b0
  yb(ispc) = yb(ispc) + y(inh4)*temp8b
  yb(inh4) = yb(inh4) + temp7b + y(ispc)*temp8b
  yb(ino3) = yb(ino3) + temp6*temp7b
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) v_spmax_nb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) THEN
    temp6b = -(v_spmax_nb/((q_sp_max_n-q_sp_rdf_n)*y(ispc)))
    yb(ispn) = yb(ispn) + temp6b
    yb(ispc) = yb(ispc) - y(ispn)*temp6b/y(ispc)
  END IF
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    pc_spmaxb = 0.D0
  ELSE
    temp5 = EXP(-(a_sp*rlt))
    temp2 = y(ispc)*pc_spmax
    temp4 = y(ispchl)*alpha_sp*rlt
    temp3 = temp4/temp2
    temp3b = y(ispc)*pc_spmax*temp5*EXP(-temp3)*growspcb/temp2
    temp2b1 = -(temp3*temp3b)
    temp2b2 = (c1-EXP(-temp3))*growspcb
    temp2b3 = y(ispc)*pc_spmax*EXP(-(a_sp*rlt))*temp2b2
    yb(ispchl) = yb(ispchl) + alpha_sp*rlt*temp3b
    alpha_spb = alpha_spb + y(ispchl)*rlt*temp3b
    rltb = rltb + y(ispchl)*alpha_sp*temp3b - a_sp*temp2b3
    yb(ispc) = yb(ispc) + temp5*pc_spmax*temp2b2 + pc_spmax*temp2b1
    pc_spmaxb = temp5*y(ispc)*temp2b2 + y(ispc)*temp2b1
    a_spb = a_spb - rlt*temp2b3
  END IF
  mu_spb = temp*pc_spmaxb
  tempb = mu_sp*pc_spmaxb
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 1) tempb = 0.D0
  CALL POPINTEGER4(branch)
  IF (branch .LT. 1) THEN
    nfunc_sp_nb = tempb
    nfunc_sp_pb = 0.D0
  ELSE
    nfunc_sp_pb = tempb
    nfunc_sp_nb = 0.D0
  END IF
  temp2b = nfunc_sp_pb/((q_sp_rdf_p-q_sp_min_p)*y(ispc))
  yb(ispp) = yb(ispp) + temp2b
  yb(ispc) = yb(ispc) - y(ispp)*temp2b/y(ispc)
  temp2b0 = nfunc_sp_nb/((q_sp_rdf_n-q_sp_min_n)*y(ispc))
  yb(ispn) = yb(ispn) + temp2b0
  yb(ispc) = yb(ispc) - y(ispn)*temp2b0/y(ispc)
  CALL POPREAL8(r_mzresp_1)
  CALL POPREAL8(mu_mz)
  CALL POPREAL8(r_prtresp_1)
  CALL POPREAL8(r_baresp_1)
  CALL POPREAL8(mu_prt)
  CALL POPREAL8(mu_ba)
  CALL POPREAL8(v_unp)
  CALL POPREAL8(v_unn)
  CALL POPREAL8(mu_un)
  CALL POPREAL8(v_trp)
  CALL POPREAL8(v_trn)
  CALL POPREAL8(mu_tr)
  CALL POPREAL8(v_spp)
  CALL POPREAL8(v_spn)
  CALL POPREAL8(mu_sp)
  tfuncb = tfuncb + mu_sp*mu_spb + v_spn*v_spnb + v_spp*v_sppb + mu_tr*&
&    mu_trb + v_trn*v_trnb + v_trp*v_trpb + mu_un*mu_unb + v_unn*v_unnb &
&    + v_unp*v_unpb + mu_ba*mu_bab + mu_prt*mu_prtb + r_baresp_1*&
&    r_baresp_1b + r_prtresp_1*r_prtresp_1b + mu_mz*mu_mzb + r_mzresp_1*&
&    r_mzresp_1b
  r_mzresp_1b = tfunc*r_mzresp_1b
  mu_mzb = tfunc*mu_mzb
  r_prtresp_1b = tfunc*r_prtresp_1b
  r_baresp_1b = tfunc*r_baresp_1b
  mu_prtb = tfunc*mu_prtb
  mu_bab = tfunc*mu_bab
  v_unpb = tfunc*v_unpb
  v_unnb = tfunc*v_unnb
  mu_unb = tfunc*mu_unb
  v_trpb = tfunc*v_trpb
  v_trnb = tfunc*v_trnb
  mu_trb = tfunc*mu_trb
  v_sppb = v_unpb + tfunc*v_sppb
  v_spnb = v_unnb + tfunc*v_spnb
  mu_spb = tfunc*mu_spb
  temp0 = 1.0/(tdat(iz, istep)+273.15) - 1.0/(tref+273.15)
  aeb = -(EXP(-(temp0*ae))*temp0*tfuncb)
  a_spb = a_spb + a_unb
  g_spb = g_spb + g_unb
  r_pomspb = r_pomspb + r_pomunb
  r_excrsp_2b = r_excrsp_2b + r_excrun_2b
  r_excrtr_nb = r_excrtr_nb + r_excrun_nb
  r_excrsp_1b = r_excrsp_1b + r_excrun_1b
  k_po4spb = k_po4spb + k_po4unb
  k_no3spb = k_no3spb + k_no3unb
  k_nh4spb = k_nh4spb + k_nh4unb
  bioparamsb(iremin) = bioparamsb(iremin) + reminb
  bioparamsb(iremin_prf_p) = bioparamsb(iremin_prf_p) + remin_prf_pb
  bioparamsb(iremin_prf_n) = bioparamsb(iremin_prf_n) + remin_prf_nb
  bioparamsb(ir_nitrf) = bioparamsb(ir_nitrf) + r_nitrfb
  bioparamsb(iq_pom_p) = bioparamsb(iq_pom_p) + q_pom_pb
  bioparamsb(iq_pom_n) = bioparamsb(iq_pom_n) + q_pom_nb
  bioparamsb(iq_refrdom_p) = bioparamsb(iq_refrdom_p) + q_refrdom_pb
  bioparamsb(iq_refrdom_n) = bioparamsb(iq_refrdom_n) + q_refrdom_nb
  bioparamsb(ir_sdomrefr) = bioparamsb(ir_sdomrefr) + r_sdomrefrb
  bioparamsb(if_hzpom) = bioparamsb(if_hzpom) + f_hzpomb
  bioparamsb(if_hzsdom) = bioparamsb(if_hzsdom) + f_hzsdomb
  bioparamsb(ir_mzremv) = bioparamsb(ir_mzremv) + r_mzremvb
  bioparamsb(ir_mzrefr) = bioparamsb(ir_mzrefr) + r_mzrefrb
  bioparamsb(ir_mzpom) = bioparamsb(ir_mzpom) + r_mzpomb
  bioparamsb(ir_mzremi) = bioparamsb(ir_mzremi) + r_mzremib
  bioparamsb(ir_mzadju) = bioparamsb(ir_mzadju) + r_mzadjub
  bioparamsb(ir_mzresp_2) = bioparamsb(ir_mzresp_2) + r_mzresp_2b
  bioparamsb(ir_mzresp_1) = bioparamsb(ir_mzresp_1) + r_mzresp_1b
  bioparamsb(if_exmzldom) = bioparamsb(if_exmzldom) + f_exmzldomb
  bioparamsb(ir_mzex) = bioparamsb(ir_mzex) + r_mzexb
  bioparamsb(ig_tr) = bioparamsb(ig_tr) + g_trb
  bioparamsb(ig_prt) = bioparamsb(ig_prt) + g_prtb
  bioparamsb(imu_mz) = bioparamsb(imu_mz) + mu_mzb
  bioparamsb(ir_pomprt) = bioparamsb(ir_pomprt) + r_pomprtb
  bioparamsb(ir_prtremi) = bioparamsb(ir_prtremi) + r_prtremib
  bioparamsb(ir_prtadju) = bioparamsb(ir_prtadju) + r_prtadjub
  bioparamsb(ir_prtresp_2) = bioparamsb(ir_prtresp_2) + r_prtresp_2b
  bioparamsb(ir_prtresp_1) = bioparamsb(ir_prtresp_1) + r_prtresp_1b
  bioparamsb(if_exprtldom) = bioparamsb(if_exprtldom) + f_exprtldomb
  bioparamsb(ir_prtex) = bioparamsb(ir_prtex) + r_prtexb
  bioparamsb(ig_ba) = bioparamsb(ig_ba) + g_bab
  bioparamsb(ig_sp) = bioparamsb(ig_sp) + g_spb
  bioparamsb(imu_prt) = bioparamsb(imu_prt) + mu_prtb
  bioparamsb(ir_bamort) = bioparamsb(ir_bamort) + r_bamortb
  bioparamsb(ir_baresp_max) = bioparamsb(ir_baresp_max) + r_baresp_maxb
  bioparamsb(ir_baresp_min) = bioparamsb(ir_baresp_min) + r_baresp_minb
  bioparamsb(ir_baresp_1) = bioparamsb(ir_baresp_1) + r_baresp_1b
  bioparamsb(if_baslct) = bioparamsb(if_baslct) + f_baslctb
  bioparamsb(ir_barefr) = bioparamsb(ir_barefr) + r_barefrb
  bioparamsb(ir_baremi) = bioparamsb(ir_baremi) + r_baremib
  bioparamsb(ir_baadju) = bioparamsb(ir_baadju) + r_baadjub
  bioparamsb(ib_baresp) = bioparamsb(ib_baresp) + b_barespb
  bioparamsb(imu_ba) = bioparamsb(imu_ba) + mu_bab
  bioparamsb(ir_sdom) = bioparamsb(ir_sdom) + r_sdomb
  bioparamsb(ik_dom) = bioparamsb(ik_dom) + k_domb
  bioparamsb(ialpha_un) = bioparamsb(ialpha_un) + alpha_unb
  bioparamsb(imu_un) = bioparamsb(imu_un) + mu_unb
  bioparamsb(ir_pomtr) = bioparamsb(ir_pomtr) + r_pomtrb
  bioparamsb(ir_excrtr_2) = bioparamsb(ir_excrtr_2) + r_excrtr_2b
  bioparamsb(ir_excrtr_n) = bioparamsb(ir_excrtr_n) + r_excrtr_nb
  bioparamsb(ir_excrtr_1) = bioparamsb(ir_excrtr_1) + r_excrtr_1b
  bioparamsb(izeta_nf) = bioparamsb(izeta_nf) + zeta_nfb
  bioparamsb(imu_picktrpo4) = bioparamsb(imu_picktrpo4) + mu_picktrpo4b
  bioparamsb(ik_po4tr) = bioparamsb(ik_po4tr) + k_po4trb
  bioparamsb(iv_trp) = bioparamsb(iv_trp) + v_trpb
  bioparamsb(ik_no3tr) = bioparamsb(ik_no3tr) + k_no3trb
  bioparamsb(ik_nh4tr) = bioparamsb(ik_nh4tr) + k_nh4trb
  bioparamsb(iv_trn) = bioparamsb(iv_trn) + v_trnb
  bioparamsb(ia_tr) = bioparamsb(ia_tr) + a_trb
  bioparamsb(ialpha_tr) = bioparamsb(ialpha_tr) + alpha_trb
  bioparamsb(imu_tr) = bioparamsb(imu_tr) + mu_trb
  bioparamsb(ir_pomsp) = bioparamsb(ir_pomsp) + r_pomspb
  bioparamsb(ir_excrsp_2) = bioparamsb(ir_excrsp_2) + r_excrsp_2b
  bioparamsb(ir_excrsp_1) = bioparamsb(ir_excrsp_1) + r_excrsp_1b
  bioparamsb(itheta) = bioparamsb(itheta) + thetab
  bioparamsb(izeta) = bioparamsb(izeta) + zetab
  bioparamsb(ik_po4sp) = bioparamsb(ik_po4sp) + k_po4spb
  bioparamsb(iv_spp) = bioparamsb(iv_spp) + v_sppb
  bioparamsb(ik_no3sp) = bioparamsb(ik_no3sp) + k_no3spb
  bioparamsb(ik_nh4sp) = bioparamsb(ik_nh4sp) + k_nh4spb
  bioparamsb(iv_spn) = bioparamsb(iv_spn) + v_spnb
  bioparamsb(ia_sp) = bioparamsb(ia_sp) + a_spb
  bioparamsb(ialpha_sp) = bioparamsb(ialpha_sp) + alpha_spb
  bioparamsb(imu_sp) = bioparamsb(imu_sp) + mu_spb
  bioparamsb(iae) = bioparamsb(iae) + aeb
  END SUBROUTINE ADDERIVS

end module adderivs_mod
